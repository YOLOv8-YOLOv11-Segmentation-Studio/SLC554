# KLTèŠ¯ç‰‡å›¾åƒåˆ†å‰²ç³»ç»Ÿï¼š yolov8-seg-GhostHGNetV2

### 1.ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰

[å‚è€ƒåšå®¢](https://gitee.com/YOLOv8_YOLOv11_Segmentation_Studio/projects)

[åšå®¢æ¥æº](https://kdocs.cn/l/cszuIiCKVNis)

ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰

éšç€è®¡ç®—æœºè§†è§‰æŠ€æœ¯çš„è¿…çŒ›å‘å±•ï¼Œå›¾åƒåˆ†å‰²ä½œä¸ºå…¶æ ¸å¿ƒä»»åŠ¡ä¹‹ä¸€ï¼Œå·²ç»åœ¨å¤šä¸ªé¢†åŸŸä¸­å±•ç°å‡ºé‡è¦çš„åº”ç”¨æ½œåŠ›ã€‚å°¤å…¶æ˜¯åœ¨è‡ªåŠ¨é©¾é©¶ã€åŒ»ç–—å½±åƒåˆ†æã€å·¥ä¸šæ£€æµ‹ç­‰é¢†åŸŸï¼Œç²¾å‡†çš„å›¾åƒåˆ†å‰²æŠ€æœ¯èƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„æ™ºèƒ½åŒ–æ°´å¹³å’Œå†³ç­–èƒ½åŠ›ã€‚è¿‘å¹´æ¥ï¼ŒYOLOï¼ˆYou Only Look Onceï¼‰ç³»åˆ—æ¨¡å‹å› å…¶é«˜æ•ˆçš„å®æ—¶æ£€æµ‹èƒ½åŠ›è€Œå—åˆ°å¹¿æ³›å…³æ³¨ã€‚YOLOv8ä½œä¸ºè¯¥ç³»åˆ—çš„æœ€æ–°ç‰ˆæœ¬ï¼Œç»“åˆäº†æ·±åº¦å­¦ä¹ çš„æœ€æ–°è¿›å±•ï¼Œå…·å¤‡äº†æ›´å¼ºçš„ç‰¹å¾æå–èƒ½åŠ›å’Œæ›´å¿«çš„å¤„ç†é€Ÿåº¦ï¼Œä¸ºå›¾åƒåˆ†å‰²ä»»åŠ¡æä¾›äº†æ–°çš„å¯èƒ½æ€§ã€‚

åœ¨æœ¬ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäºæ”¹è¿›YOLOv8çš„KLTèŠ¯ç‰‡å›¾åƒåˆ†å‰²ç³»ç»Ÿï¼Œæ—¨åœ¨è§£å†³å½“å‰å›¾åƒåˆ†å‰²æŠ€æœ¯åœ¨KLTèŠ¯ç‰‡æ£€æµ‹ä¸­çš„åº”ç”¨ç“¶é¢ˆã€‚KLTèŠ¯ç‰‡ä½œä¸ºä¸€ç§å¹¿æ³›åº”ç”¨äºç”µå­è®¾å¤‡ä¸­çš„å…³é”®ç»„ä»¶ï¼Œå…¶ç²¾ç¡®æ£€æµ‹ä¸åˆ†å‰²å¯¹äºåç»­çš„è´¨é‡æ§åˆ¶å’Œç”Ÿäº§æµç¨‹ä¼˜åŒ–è‡³å…³é‡è¦ã€‚é€šè¿‡å¯¹1400å¹…åŒ…å«ä¸‰ç±»KLTèŠ¯ç‰‡ï¼ˆKLT_32ã€KLT_43ã€KLT_64ï¼‰çš„å›¾åƒè¿›è¡Œæ·±åº¦å­¦ä¹ è®­ç»ƒï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ„å»ºä¸€ä¸ªé«˜æ•ˆã€å‡†ç¡®çš„å›¾åƒåˆ†å‰²æ¨¡å‹ï¼Œä»¥æ»¡è¶³å·¥ä¸šç”Ÿäº§ä¸­çš„å®é™…éœ€æ±‚ã€‚

æœ¬ç ”ç©¶çš„æ„ä¹‰ä¸ä»…åœ¨äºæŠ€æœ¯å±‚é¢çš„åˆ›æ–°ï¼Œæ›´åœ¨äºå…¶å¹¿æ³›çš„åº”ç”¨å‰æ™¯ã€‚é¦–å…ˆï¼Œæ”¹è¿›YOLOv8æ¨¡å‹çš„å¼•å…¥ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¿è¯åˆ†å‰²ç²¾åº¦çš„åŒæ—¶ï¼Œæå‡å¤„ç†é€Ÿåº¦ï¼Œè¿™å¯¹äºå®æ—¶ç›‘æ§å’Œè‡ªåŠ¨åŒ–ç”Ÿäº§çº¿å°¤ä¸ºé‡è¦ã€‚å…¶æ¬¡ï¼Œé’ˆå¯¹KLTèŠ¯ç‰‡çš„ç‰¹å®šéœ€æ±‚ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸“é—¨çš„æ•°æ®é›†ï¼Œæ¶µç›–äº†å¤šç§ä¸åŒçš„ç¯å¢ƒå’Œå…‰ç…§æ¡ä»¶ï¼Œç¡®ä¿æ¨¡å‹åœ¨å®é™…åº”ç”¨ä¸­çš„é²æ£’æ€§ã€‚æ­¤å¤–ï¼Œç ”ç©¶ä¸­é‡‡ç”¨çš„å®ä¾‹åˆ†å‰²æ–¹æ³•ï¼Œèƒ½å¤Ÿå¯¹æ¯ä¸ªKLTèŠ¯ç‰‡è¿›è¡Œç‹¬ç«‹è¯†åˆ«å’Œå¤„ç†ï¼Œè¿™åœ¨ä¼ ç»Ÿçš„å›¾åƒåˆ†å‰²æ–¹æ³•ä¸­å¾€å¾€éš¾ä»¥å®ç°ã€‚

é€šè¿‡å¯¹è¯¥ç³»ç»Ÿçš„ç ”ç©¶ä¸å¼€å‘ï¼Œæˆ‘ä»¬æœŸæœ›èƒ½å¤Ÿæ¨åŠ¨å›¾åƒåˆ†å‰²æŠ€æœ¯åœ¨ç”µå­åˆ¶é€ é¢†åŸŸçš„åº”ç”¨ï¼Œä¸ºè¡Œä¸šæä¾›ä¸€ç§æ–°çš„è§£å†³æ–¹æ¡ˆã€‚åŒæ—¶ï¼Œæœ¬ç ”ç©¶ä¹Ÿä¸ºåç»­çš„å­¦æœ¯ç ”ç©¶æä¾›äº†æ•°æ®é›†å’Œæ¨¡å‹åŸºç¡€ï¼Œä¿ƒè¿›ç›¸å…³é¢†åŸŸçš„æ·±å…¥æ¢ç´¢ã€‚æœªæ¥ï¼Œéšç€æ·±åº¦å­¦ä¹ æŠ€æœ¯çš„ä¸æ–­è¿›æ­¥å’Œç¡¬ä»¶æ€§èƒ½çš„æå‡ï¼ŒåŸºäºYOLOv8çš„å›¾åƒåˆ†å‰²ç³»ç»Ÿæœ‰æœ›åœ¨æ›´å¤šçš„åº”ç”¨åœºæ™¯ä¸­å‘æŒ¥é‡è¦ä½œç”¨ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒåŸºäºæ”¹è¿›YOLOv8çš„KLTèŠ¯ç‰‡å›¾åƒåˆ†å‰²ç³»ç»Ÿçš„ç ”ç©¶ï¼Œä¸ä»…å…·æœ‰é‡è¦çš„ç†è®ºä»·å€¼ï¼Œä¹Ÿå…·å¤‡å¹¿æ³›çš„å®é™…åº”ç”¨æ„ä¹‰ã€‚é€šè¿‡æ·±å…¥æ¢è®¨è¯¥ç³»ç»Ÿçš„æ„å»ºä¸ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä¸ºå›¾åƒåˆ†å‰²æŠ€æœ¯çš„å‘å±•è´¡çŒ®æ–°çš„æ€è·¯ä¸æ–¹æ³•ï¼Œæ¨åŠ¨æ™ºèƒ½åˆ¶é€ çš„è¿›ç¨‹ã€‚

### 2.å›¾ç‰‡æ¼”ç¤º

![1.png](1.png)

![2.png](2.png)

![3.png](3.png)

æ³¨æ„ï¼šæœ¬é¡¹ç›®æä¾›å®Œæ•´çš„è®­ç»ƒæºç æ•°æ®é›†å’Œè®­ç»ƒæ•™ç¨‹,ç”±äºæ­¤åšå®¢ç¼–è¾‘è¾ƒæ—©,æš‚ä¸æä¾›æƒé‡æ–‡ä»¶ï¼ˆbest.ptï¼‰,éœ€è¦æŒ‰ç…§6.è®­ç»ƒæ•™ç¨‹è¿›è¡Œè®­ç»ƒåå®ç°ä¸Šå›¾æ•ˆæœã€‚

### 3.è§†é¢‘æ¼”ç¤º

[3.1 è§†é¢‘æ¼”ç¤º](https://www.bilibili.com/video/BV17nzXYmEKR/)

### 4.æ•°æ®é›†ä¿¡æ¯

##### 4.1 æ•°æ®é›†ç±»åˆ«æ•°ï¼†ç±»åˆ«å

nc: 2
names: ['KLT_43', 'KLT_64']


##### 4.2 æ•°æ®é›†ä¿¡æ¯ç®€ä»‹

æ•°æ®é›†ä¿¡æ¯å±•ç¤º

åœ¨æœ¬ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†åä¸ºâ€œSLCâ€çš„æ•°æ®é›†ï¼Œä»¥æ”¯æŒå¯¹æ”¹è¿›YOLOv8-segçš„KLTèŠ¯ç‰‡å›¾åƒåˆ†å‰²ç³»ç»Ÿçš„è®­ç»ƒå’ŒéªŒè¯ã€‚è¯¥æ•°æ®é›†ä¸“é—¨è®¾è®¡ç”¨äºå¤„ç†KLTèŠ¯ç‰‡å›¾åƒï¼Œå…·æœ‰ä¸°å¯Œçš„æ ·æœ¬å’Œå¤šæ ·çš„åœºæ™¯ï¼Œæ—¨åœ¨æå‡å›¾åƒåˆ†å‰²çš„ç²¾åº¦å’Œæ•ˆç‡ã€‚SLCæ•°æ®é›†åŒ…å«ä¸¤ä¸ªä¸»è¦ç±»åˆ«ï¼Œåˆ†åˆ«ä¸ºâ€œKLT_43â€å’Œâ€œKLT_64â€ï¼Œè¿™ä¸¤ä¸ªç±»åˆ«ä»£è¡¨äº†ä¸åŒå‹å·çš„KLTèŠ¯ç‰‡ï¼Œå…·æœ‰å„è‡ªç‹¬ç‰¹çš„ç‰¹å¾å’Œåº”ç”¨åœºæ™¯ã€‚

KLT_43ç±»åˆ«çš„å›¾åƒæ ·æœ¬ä¸»è¦é›†ä¸­åœ¨è¯¥å‹å·èŠ¯ç‰‡çš„ç‰¹å®šåº”ç”¨ç¯å¢ƒä¸­ï¼Œå±•ç°äº†å…¶åœ¨å®é™…æ“ä½œä¸­çš„è¡¨ç°ã€‚è¿™äº›å›¾åƒæ¶µç›–äº†å¤šç§å…‰ç…§æ¡ä»¶ã€èƒŒæ™¯å¤æ‚åº¦å’Œè§†è§’å˜åŒ–ï¼Œä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­èƒ½å¤Ÿå­¦ä¹ åˆ°KLT_43èŠ¯ç‰‡çš„å¤šæ ·æ€§å’Œå¤æ‚æ€§ã€‚é€šè¿‡å¯¹è¿™äº›å›¾åƒçš„ç»†è‡´æ ‡æ³¨ï¼Œæ•°æ®é›†ä¸ºYOLOv8-segæ¨¡å‹æä¾›äº†ä¸°å¯Œçš„è®­ç»ƒç´ æï¼Œå¸®åŠ©å…¶åœ¨å›¾åƒåˆ†å‰²ä»»åŠ¡ä¸­æ›´å¥½åœ°è¯†åˆ«å’Œåˆ†ç¦»å‡ºKLT_43èŠ¯ç‰‡çš„è½®å»“ã€‚

å¦ä¸€æ–¹é¢ï¼ŒKLT_64ç±»åˆ«åˆ™ä»£è¡¨äº†å¦ä¸€ç§å‹å·çš„KLTèŠ¯ç‰‡ï¼Œå…¶ç‰¹å¾å’Œåº”ç”¨åœºæ™¯ä¸KLT_43æœ‰æ‰€ä¸åŒã€‚KLT_64çš„å›¾åƒæ ·æœ¬åŒæ ·æ¶µç›–äº†å¤šç§ç¯å¢ƒå’Œæ¡ä»¶ï¼Œç¡®ä¿æ¨¡å‹èƒ½å¤Ÿé€‚åº”ä¸åŒçš„å®é™…åº”ç”¨éœ€æ±‚ã€‚é€šè¿‡å¯¹KLT_64çš„å›¾åƒè¿›è¡Œç²¾ç¡®æ ‡æ³¨ï¼Œæ•°æ®é›†ä¸ºæ¨¡å‹æä¾›äº†å¿…è¦çš„è®­ç»ƒåŸºç¡€ï¼Œä½¿å…¶èƒ½å¤Ÿæœ‰æ•ˆåœ°è¿›è¡Œå›¾åƒåˆ†å‰²ï¼Œè¯†åˆ«å‡ºKLT_64èŠ¯ç‰‡çš„è¾¹ç•Œå’Œç»†èŠ‚ã€‚

SLCæ•°æ®é›†çš„æ„å»ºè¿‡ç¨‹æ³¨é‡æ•°æ®çš„å¤šæ ·æ€§å’Œä»£è¡¨æ€§ï¼Œç¡®ä¿æ¯ä¸ªç±»åˆ«çš„æ ·æœ¬æ•°é‡å‡è¡¡ä¸”å…·æœ‰è‰¯å¥½çš„è¦†ç›–é¢ã€‚è¿™ç§è®¾è®¡ä¸ä»…æœ‰åŠ©äºæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œè¿˜èƒ½æœ‰æ•ˆé™ä½è¿‡æ‹Ÿåˆçš„é£é™©ã€‚æ•°æ®é›†ä¸­æ¯ä¸ªç±»åˆ«çš„æ ·æœ¬éƒ½ç»è¿‡ä¸¥æ ¼çš„æ ‡æ³¨å’Œå®¡æ ¸ï¼Œç¡®ä¿æ ‡æ³¨çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ï¼Œä»è€Œä¸ºæ¨¡å‹çš„è®­ç»ƒæä¾›é«˜è´¨é‡çš„æ•°æ®æ”¯æŒã€‚

åœ¨å›¾åƒåˆ†å‰²ä»»åŠ¡ä¸­ï¼ŒYOLOv8-segæ¨¡å‹é€šè¿‡å¯¹SLCæ•°æ®é›†çš„å­¦ä¹ ï¼Œèƒ½å¤Ÿåœ¨å¤æ‚çš„å›¾åƒèƒŒæ™¯ä¸­å‡†ç¡®è¯†åˆ«å‡ºKLTèŠ¯ç‰‡çš„ç‰¹å¾ã€‚è¿™ä¸€è¿‡ç¨‹ä¸ä»…ä¾èµ–äºæ•°æ®é›†çš„ä¸°å¯Œæ€§å’Œå¤šæ ·æ€§ï¼Œè¿˜éœ€è¦æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­ä¼˜åŒ–å…¶å‚æ•°ï¼Œä»¥é€‚åº”ä¸åŒç±»åˆ«çš„ç‰¹å¾ã€‚é€šè¿‡å¯¹SLCæ•°æ®é›†çš„æ·±å…¥åˆ†æå’Œåº”ç”¨ï¼Œæˆ‘ä»¬æœŸæœ›èƒ½å¤Ÿæ˜¾è‘—æå‡KLTèŠ¯ç‰‡å›¾åƒåˆ†å‰²çš„æ•ˆæœï¼Œä¸ºç›¸å…³é¢†åŸŸçš„ç ”ç©¶å’Œåº”ç”¨æä¾›æ›´ä¸ºç²¾å‡†çš„æŠ€æœ¯æ”¯æŒã€‚

æ€»ä¹‹ï¼ŒSLCæ•°æ®é›†ä¸ºæ”¹è¿›YOLOv8-segçš„KLTèŠ¯ç‰‡å›¾åƒåˆ†å‰²ç³»ç»Ÿæä¾›äº†åšå®çš„åŸºç¡€ã€‚é€šè¿‡å¯¹KLT_43å’ŒKLT_64ä¸¤ä¸ªç±»åˆ«çš„æ·±å…¥å­¦ä¹ ï¼Œæ¨¡å‹å°†èƒ½å¤Ÿåœ¨å®é™…åº”ç”¨ä¸­å±•ç°å‡ºæ›´é«˜çš„åˆ†å‰²ç²¾åº¦å’Œé²æ£’æ€§ï¼Œä¸ºæœªæ¥çš„ç ”ç©¶å’ŒæŠ€æœ¯å‘å±•å¥ å®šè‰¯å¥½çš„åŸºç¡€ã€‚

![4.png](4.png)

![5.png](5.png)

![6.png](6.png)

![7.png](7.png)

![8.png](8.png)

### 5.é¡¹ç›®ä¾èµ–ç¯å¢ƒéƒ¨ç½²æ•™ç¨‹ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰

[5.1 ç¯å¢ƒéƒ¨ç½²æ•™ç¨‹é“¾æ¥ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰](https://www.bilibili.com/video/BV1jG4Ve4E9t/?vd_source=bc9aec86d164b67a7004b996143742dc)




[5.2 å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒåˆ›å»ºå’Œä¾èµ–åº“å®‰è£…è§†é¢‘æ•™ç¨‹é“¾æ¥ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰](https://www.bilibili.com/video/BV1nA4VeYEze/?vd_source=bc9aec86d164b67a7004b996143742dc)

### 6.æ‰‹æŠŠæ‰‹YOLOV8-segè®­ç»ƒè§†é¢‘æ•™ç¨‹ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰

[6.1 æ‰‹æŠŠæ‰‹YOLOV8-segè®­ç»ƒè§†é¢‘æ•™ç¨‹ï¼ˆé›¶åŸºç¡€å°ç™½æœ‰æ‰‹å°±èƒ½å­¦ä¼šï¼‰](https://www.bilibili.com/video/BV1cA4VeYETe/?vd_source=bc9aec86d164b67a7004b996143742dc)


æŒ‰ç…§ä¸Šé¢çš„è®­ç»ƒè§†é¢‘æ•™ç¨‹é“¾æ¥åŠ è½½é¡¹ç›®æä¾›çš„æ•°æ®é›†ï¼Œè¿è¡Œtrain.pyå³å¯å¼€å§‹è®­ç»ƒ
ï»¿


     Epoch   gpu_mem       box       obj       cls    labels  img_size
     1/200     0G   0.01576   0.01955  0.007536        22      1280: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 849/849 [14:42<00:00,  1.04s/it]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 213/213 [01:14<00:00,  2.87it/s]
                 all       3395      17314      0.994      0.957      0.0957      0.0843

     Epoch   gpu_mem       box       obj       cls    labels  img_size
     2/200     0G   0.01578   0.01923  0.007006        22      1280: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 849/849 [14:44<00:00,  1.04s/it]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 213/213 [01:12<00:00,  2.95it/s]
                 all       3395      17314      0.996      0.956      0.0957      0.0845

     Epoch   gpu_mem       box       obj       cls    labels  img_size
     3/200     0G   0.01561    0.0191  0.006895        27      1280: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 849/849 [10:56<00:00,  1.29it/s]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   | 187/213 [00:52<00:00,  4.04it/s]
                 all       3395      17314      0.996      0.957      0.0957      0.0845




### 7.50+ç§å…¨å¥—YOLOV8-segåˆ›æ–°ç‚¹åŠ è½½è°ƒå‚å®éªŒè§†é¢‘æ•™ç¨‹ï¼ˆä¸€é”®åŠ è½½å†™å¥½çš„æ”¹è¿›æ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼‰

[7.1 50+ç§å…¨å¥—YOLOV8-segåˆ›æ–°ç‚¹åŠ è½½è°ƒå‚å®éªŒè§†é¢‘æ•™ç¨‹ï¼ˆä¸€é”®åŠ è½½å†™å¥½çš„æ”¹è¿›æ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼‰](https://www.bilibili.com/video/BV1Hw4VePEXv/?vd_source=bc9aec86d164b67a7004b996143742dc)

### YOLOV8-segç®—æ³•ç®€ä»‹

åŸå§‹YOLOv8-segç®—æ³•åŸç†

YOLOv8-segç®—æ³•æ˜¯ç”±Glenn-Jocheræå‡ºçš„ä¸€ç§æ–°å‹ç›®æ ‡æ£€æµ‹ä¸åˆ†å‰²ç®—æ³•ï¼Œä½œä¸ºYOLOç³»åˆ—çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå®ƒåœ¨YOLOv3å’ŒYOLOv5çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å¤šé¡¹åˆ›æ–°ä¸æ”¹è¿›ï¼Œæ—¨åœ¨æå‡ç›®æ ‡æ£€æµ‹çš„ç²¾åº¦å’Œé€Ÿåº¦ï¼Œå°¤å…¶æ˜¯åœ¨å¤æ‚åœºæ™¯ä¸‹çš„è¡¨ç°ã€‚YOLOv8-segä¸ä»…ä¿ç•™äº†YOLOç³»åˆ—ä¸€è´¯çš„é«˜æ•ˆæ€§ï¼Œè¿˜å¼•å…¥äº†æ›´ä¸ºå…ˆè¿›çš„åˆ†å‰²åŠŸèƒ½ï¼Œä½¿å…¶åœ¨ç›®æ ‡æ£€æµ‹å’Œå®ä¾‹åˆ†å‰²ä»»åŠ¡ä¸­å‡èƒ½è¡¨ç°å‡ºè‰²ã€‚

é¦–å…ˆï¼ŒYOLOv8-segåœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µå»¶ç»­äº†YOLOv5çš„ç­–ç•¥ï¼Œé‡‡ç”¨äº†å¤šç§æ•°æ®å¢å¼ºæŠ€æœ¯ä»¥æé«˜æ¨¡å‹çš„é²æ£’æ€§å’Œæ³›åŒ–èƒ½åŠ›ã€‚å…·ä½“è€Œè¨€ï¼Œç®—æ³•ä½¿ç”¨äº†é©¬èµ›å…‹å¢å¼ºï¼ˆMosaicï¼‰ã€æ··åˆå¢å¼ºï¼ˆMixupï¼‰ã€ç©ºé—´æ‰°åŠ¨ï¼ˆRandom Perspectiveï¼‰å’Œé¢œè‰²æ‰°åŠ¨ï¼ˆHSV Augmentï¼‰ç­‰æ–¹æ³•ã€‚è¿™äº›å¢å¼ºæ‰‹æ®µé€šè¿‡å¯¹è®­ç»ƒæ•°æ®è¿›è¡Œå¤šæ ·åŒ–å¤„ç†ï¼Œå¸®åŠ©æ¨¡å‹æ›´å¥½åœ°å­¦ä¹ åˆ°ç›®æ ‡çš„ç‰¹å¾ï¼Œå‡å°‘è¿‡æ‹Ÿåˆç°è±¡ï¼Œä»è€Œæå‡æ£€æµ‹ç²¾åº¦ã€‚

åœ¨éª¨å¹²ç½‘ç»œç»“æ„æ–¹é¢ï¼ŒYOLOv8-segå¯¹YOLOv5çš„è®¾è®¡è¿›è¡Œäº†ä¼˜åŒ–ã€‚YOLOv5çš„ä¸»å¹²ç½‘ç»œé‡‡ç”¨äº†å±‚æ¬¡åˆ†æ˜çš„C3æ¨¡å—ï¼Œè€ŒYOLOv8-segåˆ™å°†å…¶æ›¿æ¢ä¸ºæ–°çš„C2fæ¨¡å—ã€‚C2fæ¨¡å—çš„è®¾è®¡ç†å¿µåœ¨äºå¼•å…¥æ›´å¤šçš„åˆ†æ”¯ï¼Œä»¥ä¸°å¯Œæ¢¯åº¦å›ä¼ æ—¶çš„æ”¯æµï¼Œä»è€Œæé«˜ç‰¹å¾æå–çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚è¿™ç§ç»“æ„çš„æ”¹è¿›ä½¿å¾—YOLOv8-segåœ¨å¤„ç†å¤æ‚åœºæ™¯æ—¶ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°æ•æ‰åˆ°å¤šæ ·åŒ–çš„ç‰¹å¾ä¿¡æ¯ã€‚

YOLOv8-segåŒæ ·é‡‡ç”¨äº†ç‰¹å¾é‡‘å­—å¡”ç½‘ç»œï¼ˆFPNï¼‰å’Œè·¯å¾„èšåˆç½‘ç»œï¼ˆPANï¼‰ç»“æ„ï¼Œä»¥å®ç°å¤šå°ºåº¦ä¿¡æ¯çš„å……åˆ†èåˆã€‚FPN-PANç»“æ„çš„è®¾è®¡ä½¿å¾—ä¸åŒå°ºåº¦çš„ç‰¹å¾èƒ½å¤Ÿæœ‰æ•ˆåœ°è¿›è¡Œäº¤äº’ï¼Œä»è€Œå¢å¼ºæ¨¡å‹å¯¹å°ç›®æ ‡å’Œå¤§ç›®æ ‡çš„æ£€æµ‹èƒ½åŠ›ã€‚åœ¨YOLOv8-segä¸­ï¼ŒC3æ¨¡å—è¢«æ›¿æ¢ä¸ºC2fæ¨¡å—ï¼Œä½¿å¾—ç‰¹å¾èåˆçš„è¿‡ç¨‹æ›´åŠ é«˜æ•ˆï¼Œè¿›ä¸€æ­¥æå‡äº†æ¨¡å‹çš„æ•´ä½“æ€§èƒ½ã€‚

åœ¨æ£€æµ‹å¤´çš„è®¾è®¡ä¸Šï¼ŒYOLOv8-segå¼•å…¥äº†è§£è€¦å¤´ï¼ˆDecoupled Headï¼‰ç»“æ„ï¼Œæ ‡å¿—ç€YOLOç³»åˆ—åœ¨æ£€æµ‹å¤´è®¾è®¡ä¸Šçš„ä¸€æ¬¡é‡è¦å˜é©ã€‚ä¼ ç»Ÿçš„è€¦åˆæ£€æµ‹å¤´é€šè¿‡ä¸€å±‚å·ç§¯åŒæ—¶å®Œæˆåˆ†ç±»å’Œå®šä½ä»»åŠ¡ï¼Œè€ŒYOLOv8-segåˆ™å°†è¿™ä¸¤ä¸ªä»»åŠ¡åˆ†å¼€å¤„ç†ï¼Œé‡‡ç”¨ä¸¤æ¡å¹¶è¡Œçš„åˆ†æ”¯åˆ†åˆ«æå–ç±»åˆ«ç‰¹å¾å’Œä½ç½®ç‰¹å¾ã€‚è¿™æ ·çš„è®¾è®¡ä¸ä»…æé«˜äº†æ¨¡å‹çš„çµæ´»æ€§ï¼Œè¿˜ä½¿å¾—åˆ†ç±»å’Œå®šä½çš„ç²¾åº¦å¾—åˆ°äº†æ˜¾è‘—æå‡ã€‚

åœ¨æ ‡ç­¾åˆ†é…ç­–ç•¥æ–¹é¢ï¼ŒYOLOv8-segæ‘’å¼ƒäº†ä¾èµ–äºæ•°æ®é›†çš„å€™é€‰æ¡†èšç±»ç­–ç•¥ï¼Œè½¬è€Œé‡‡ç”¨äº†ä¸€ç§åŠ¨æ€æ ‡ç­¾åˆ†é…ç­–ç•¥ã€‚è¿™ç§ç­–ç•¥åŸºäºTOODï¼ˆTask-Oriented Object Detectionï¼‰æ–¹æ³•ï¼Œé€šè¿‡å¯¹ç›®æ ‡æ¡†å’Œç›®æ ‡åˆ†æ•°çš„åŠ¨æ€è°ƒæ•´ï¼Œä¼˜åŒ–äº†æ­£è´Ÿæ ·æœ¬çš„åŒ¹é…è¿‡ç¨‹ã€‚YOLOv8-segçš„æŸå¤±å‡½æ•°ä¸»è¦ç”±ç±»åˆ«æŸå¤±å’Œä½ç½®æŸå¤±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ç±»åˆ«æŸå¤±é‡‡ç”¨äº†å˜ç„¦æŸå¤±ï¼ˆVarifocal Lossï¼‰ï¼Œè€Œä½ç½®æŸå¤±åˆ™ç»“åˆäº†CIoU Losså’ŒDFL Lossã€‚è¿™ç§è®¾è®¡ä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ›´åŠ å…³æ³¨é«˜è´¨é‡çš„æ­£æ ·æœ¬ï¼Œä»è€Œæå‡æ•´ä½“çš„æ£€æµ‹æ€§èƒ½ã€‚

æ­¤å¤–ï¼ŒYOLOv8-segåœ¨å®ç°ç›®æ ‡åˆ†å‰²çš„è¿‡ç¨‹ä¸­ï¼Œåˆ©ç”¨äº†å…¶ç‹¬ç‰¹çš„ç½‘ç»œç»“æ„å’ŒæŸå¤±å‡½æ•°è®¾è®¡ï¼Œä½¿å¾—æ¨¡å‹ä¸ä»…èƒ½å¤Ÿè¯†åˆ«ç›®æ ‡ï¼Œè¿˜èƒ½ç²¾ç¡®åœ°åˆ†å‰²å‡ºç›®æ ‡çš„è½®å»“ã€‚è¿™ä¸€ç‰¹æ€§ä½¿å¾—YOLOv8-segåœ¨å®é™…åº”ç”¨ä¸­å…·å¤‡äº†æ›´å¼ºçš„å®ç”¨æ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³å¤æ‚åœºæ™¯ä¸‹çš„ç›®æ ‡æ£€æµ‹ä¸åˆ†å‰²éœ€æ±‚ã€‚

æ€»çš„æ¥è¯´ï¼ŒYOLOv8-segç®—æ³•é€šè¿‡ä¸€ç³»åˆ—åˆ›æ–°çš„è®¾è®¡ä¸æ”¹è¿›ï¼Œæå‡äº†ç›®æ ‡æ£€æµ‹ä¸åˆ†å‰²çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚å…¶åœ¨æ•°æ®é¢„å¤„ç†ã€éª¨å¹²ç½‘ç»œã€ç‰¹å¾èåˆã€æ£€æµ‹å¤´è®¾è®¡åŠæ ‡ç­¾åˆ†é…ç­–ç•¥ç­‰æ–¹é¢çš„ä¼˜åŒ–ï¼Œä½¿å¾—YOLOv8-segæˆä¸ºäº†ä¸€ä¸ªåœ¨å®æ—¶æ£€æµ‹å’Œå®ä¾‹åˆ†å‰²é¢†åŸŸéƒ½å…·æœ‰ç«äº‰åŠ›çš„æ¨¡å‹ã€‚éšç€YOLOv8-segçš„æ¨å‡ºï¼Œç›®æ ‡æ£€æµ‹æŠ€æœ¯å°†è¿æ¥æ–°çš„å‘å±•æœºé‡ï¼Œä¸ºå„ç±»åº”ç”¨åœºæ™¯æä¾›äº†æ›´ä¸ºå¼ºå¤§çš„æŠ€æœ¯æ”¯æŒã€‚

![18.png](18.png)

### 9.ç³»ç»ŸåŠŸèƒ½å±•ç¤ºï¼ˆæ£€æµ‹å¯¹è±¡ä¸ºä¸¾ä¾‹ï¼Œå®é™…å†…å®¹ä»¥æœ¬é¡¹ç›®æ•°æ®é›†ä¸ºå‡†ï¼‰

å›¾9.1.ç³»ç»Ÿæ”¯æŒæ£€æµ‹ç»“æœè¡¨æ ¼æ˜¾ç¤º

  å›¾9.2.ç³»ç»Ÿæ”¯æŒç½®ä¿¡åº¦å’ŒIOUé˜ˆå€¼æ‰‹åŠ¨è°ƒèŠ‚

  å›¾9.3.ç³»ç»Ÿæ”¯æŒè‡ªå®šä¹‰åŠ è½½æƒé‡æ–‡ä»¶best.pt(éœ€è¦ä½ é€šè¿‡æ­¥éª¤5ä¸­è®­ç»ƒè·å¾—)

  å›¾9.4.ç³»ç»Ÿæ”¯æŒæ‘„åƒå¤´å®æ—¶è¯†åˆ«

  å›¾9.5.ç³»ç»Ÿæ”¯æŒå›¾ç‰‡è¯†åˆ«

  å›¾9.6.ç³»ç»Ÿæ”¯æŒè§†é¢‘è¯†åˆ«

  å›¾9.7.ç³»ç»Ÿæ”¯æŒè¯†åˆ«ç»“æœæ–‡ä»¶è‡ªåŠ¨ä¿å­˜

  å›¾9.8.ç³»ç»Ÿæ”¯æŒExcelå¯¼å‡ºæ£€æµ‹ç»“æœæ•°æ®

![10.png](10.png)

![11.png](11.png)

![12.png](12.png)

![13.png](13.png)

![14.png](14.png)

![15.png](15.png)

![16.png](16.png)

![17.png](17.png)

### 10.50+ç§å…¨å¥—YOLOV8-segåˆ›æ–°ç‚¹åŸç†è®²è§£ï¼ˆéç§‘ç­ä¹Ÿå¯ä»¥è½»æ¾å†™åˆŠå‘åˆŠï¼ŒV11ç‰ˆæœ¬æ­£åœ¨ç§‘ç ”å¾…æ›´æ–°ï¼‰

#### 10.1 ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæ¯ä¸ªåˆ›æ–°ç‚¹çš„å…·ä½“åŸç†è®²è§£å°±ä¸ä¸€ä¸€å±•å¼€ï¼Œå…·ä½“è§ä¸‹åˆ—ç½‘å€ä¸­çš„åˆ›æ–°ç‚¹å¯¹åº”å­é¡¹ç›®çš„æŠ€æœ¯åŸç†åšå®¢ç½‘å€ã€Blogã€‘ï¼š

![9.png](9.png)

[10.1 50+ç§å…¨å¥—YOLOV8-segåˆ›æ–°ç‚¹åŸç†è®²è§£é“¾æ¥](https://gitee.com/qunmasj/good)

#### 10.2 éƒ¨åˆ†æ”¹è¿›æ¨¡å—åŸç†è®²è§£(å®Œæ•´çš„æ”¹è¿›åŸç†è§ä¸Šå›¾å’ŒæŠ€æœ¯åšå®¢é“¾æ¥)ã€å¦‚æœæ­¤å°èŠ‚çš„å›¾åŠ è½½å¤±è´¥å¯ä»¥é€šè¿‡CSDNæˆ–è€…Githubæœç´¢è¯¥åšå®¢çš„æ ‡é¢˜è®¿é—®åŸå§‹åšå®¢ï¼ŒåŸå§‹åšå®¢å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸ã€‘
ï»¿### å¯å˜æ€§å·ç§¯DCNç®€ä»‹
å·ç§¯ç¥ç»ç½‘ç»œç”±äºå…¶æ„å»ºæ¨¡å—ä¸­å›ºå®šçš„å‡ ä½•ç»“æ„ï¼Œæœ¬è´¨ä¸Šå—é™äºæ¨¡å‹å‡ ä½•å˜æ¢ã€‚ä¸ºäº†æé«˜å·ç§¯ç¥ç»ç½‘ç»œçš„è½¬æ¢å»ºæ¨¡èƒ½åŠ›ï¼Œã€ŠDeformable Convolutional Networksã€‹ä½œè€…æå‡ºäº†ä¸¤ä¸ªæ¨¡å—ï¼šå¯å˜å½¢å·ç§¯ï¼ˆdeformable convolutionï¼‰å’Œå¯å˜å½¢RoIæ± ï¼ˆdeformable RoI poolingï¼‰ã€‚è¿™ä¸¤ä¸ªæ¨¡å—å‡åŸºäºç”¨é¢å¤–çš„åç§»æ¥å¢åŠ æ¨¡å—ä¸­çš„ç©ºé—´é‡‡æ ·ä½ç½®ä»¥åŠä»ç›®æ ‡ä»»åŠ¡ä¸­å­¦ä¹ åç§»çš„æ€æƒ³ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„ç›‘ç£ã€‚

ç¬¬ä¸€æ¬¡è¯æ˜äº†åœ¨æ·±åº¦ç¥ç»ç½‘ç»œä¸­å­¦ä¹ å¯†é›†ç©ºé—´å˜æ¢ï¼ˆdense spatial transformationï¼‰å¯¹äºå¤æ‚çš„è§†è§‰ä»»åŠ¡æ˜¯æœ‰æ•ˆçš„

è§†è§‰è¯†åˆ«ä¸­çš„ä¸€ä¸ªå…³é”®æŒ‘æˆ˜æ˜¯å¦‚ä½•é€‚åº”å¯¹è±¡æ¯”ä¾‹ã€å§¿æ€ã€è§†ç‚¹å’Œé›¶ä»¶å˜å½¢ä¸­çš„å‡ ä½•å˜åŒ–æˆ–æ¨¡å‹å‡ ä½•å˜æ¢ã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•å®ç°ï¼š
1ï¼‰å»ºç«‹å…·æœ‰è¶³å¤ŸæœŸæœ›å˜åŒ–çš„è®­ç»ƒæ•°æ®é›†ã€‚è¿™é€šå¸¸é€šè¿‡å¢åŠ ç°æœ‰çš„æ•°æ®æ ·æœ¬æ¥å®ç°ï¼Œä¾‹å¦‚é€šè¿‡ä»¿å°„å˜æ¢ã€‚ä½†æ˜¯è®­ç»ƒæˆæœ¬æ˜‚è´µè€Œä¸”æ¨¡å‹å‚æ•°åºå¤§ã€‚
2ï¼‰ä½¿ç”¨å˜æ¢ä¸å˜ï¼ˆtransformation-invariantï¼‰çš„ç‰¹å¾å’Œç®—æ³•ã€‚æ¯”å¦‚æ¯”è¾ƒæœ‰åçš„SIFT(å°ºåº¦ä¸å˜ç‰¹å¾å˜æ¢)ä¾¿æ˜¯è¿™ä¸€ç±»çš„ä»£è¡¨ç®—æ³•ã€‚

ä½†ä»¥ä¸Šçš„æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š
1ï¼‰å‡ ä½•å˜æ¢è¢«å‡å®šä¸ºå›ºå®šçš„å’Œå·²çŸ¥çš„ï¼Œè¿™äº›å…ˆéªŒçŸ¥è¯†è¢«ç”¨æ¥æ‰©å……æ•°æ®ï¼Œè®¾è®¡ç‰¹å¾å’Œç®—æ³•ã€‚ä¸ºæ­¤ï¼Œè¿™ä¸ªå‡è®¾é˜»æ­¢äº†å¯¹å…·æœ‰æœªçŸ¥å‡ ä½•å˜æ¢çš„æ–°ä»»åŠ¡çš„æ¨å¹¿ï¼Œä»è€Œå¯¼è‡´è¿™äº›å‡ ä½•å˜æ¢å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®å»ºæ¨¡ã€‚
2ï¼‰å¯¹äºä¸å˜ç‰¹å¾å’Œç®—æ³•è¿›è¡Œæ‰‹åŠ¨è®¾è®¡ï¼Œå¯¹äºè¿‡äºå¤æ‚çš„å˜æ¢å¯èƒ½æ˜¯å›°éš¾çš„æˆ–ä¸å¯è¡Œçš„ã€‚

å·ç§¯ç¥ç»ç½‘ç»œæœ¬è´¨ä¸Šå±€é™äºæ¨¡æ‹Ÿå¤§å‹æœªçŸ¥è½¬æ¢ã€‚å±€é™æ€§æºäºCNNæ¨¡å—çš„å›ºå®šå‡ ä½•ç»“æ„ï¼šå·ç§¯å•å…ƒåœ¨å›ºå®šä½ç½®å¯¹è¾“å…¥ç‰¹å¾å›¾è¿›è¡Œé‡‡æ ·ï¼›æ± åŒ–å±‚ä»¥å›ºå®šæ¯”ç‡é™ä½ç‰¹å¾çŸ©é˜µåˆ†è¾¨ç‡ï¼›RoIï¼ˆæ„Ÿå…´è¶£åŒºåŸŸï¼‰æ± åŒ–å±‚å°†RoIåˆ†æˆå›ºå®šçš„ç©ºé—´ç®±ï¼ˆspatial binsï¼‰ç­‰ã€‚ç¼ºä¹å¤„ç†å‡ ä½•å˜æ¢çš„å†…éƒ¨æœºåˆ¶ã€‚

è¿™ç§å†…éƒ¨æœºåˆ¶çš„ç¼ºä¹ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­ã€‚åŒä¸€ä¸ªCNNå±‚ä¸­æ‰€æœ‰æ¿€æ´»å•å…ƒçš„æ„Ÿå—é‡å¤§å°æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯è¿™æ˜¯ä¸å¯å–çš„ã€‚å› ä¸ºä¸åŒçš„ä½ç½®å¯èƒ½å¯¹åº”äºå…·æœ‰ä¸åŒå°ºåº¦æˆ–å˜å½¢çš„å¯¹è±¡ï¼Œæ‰€ä»¥å°ºåº¦æˆ–æ„Ÿå—é‡å¤§å°çš„è‡ªé€‚åº”ç¡®å®šå¯¹äºå…·æœ‰ç²¾ç»†å®šä½çš„è§†è§‰è¯†åˆ«æ˜¯æ¸´æœ›çš„ã€‚

å¯¹äºè¿™äº›é—®é¢˜ï¼Œä½œè€…æå‡ºäº†ä¸¤ä¸ªæ¨¡å—æé«˜CNNså¯¹å‡ ä½•å˜æ¢å»ºæ¨¡çš„èƒ½åŠ›ã€‚


deformable convolutionï¼ˆå¯å˜å½¢å·ç§¯ï¼‰
å°†2Dåç§»é‡æ·»åŠ åˆ°æ ‡å‡†å·ç§¯ä¸­çš„å¸¸è§„ç½‘æ ¼é‡‡æ ·ä½ç½®ï¼Œä½¿å¾—é‡‡æ ·ç½‘æ ¼èƒ½å¤Ÿè‡ªç”±å˜å½¢ã€‚é€šè¿‡é¢å¤–çš„å·ç§¯å±‚ï¼Œä»å‰é¢çš„ç‰¹å¾æ˜ å°„ä¸­å­¦ä¹ åç§»ã€‚å› æ­¤ï¼Œå˜å½¢é‡‡ç”¨å±€éƒ¨ã€å¯†é›†å’Œè‡ªé€‚åº”çš„æ–¹å¼å–å†³äºè¾“å…¥ç‰¹å¾ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/3291fa03a6014fceb820fa57ad10bdc7.png)

deformable RoI poolingï¼ˆå¯å˜å½¢RoIæ± åŒ–ï¼‰
ä¸ºå…ˆå‰RoIæ± åŒ–çš„å¸¸è§„åº“ï¼ˆbinï¼‰åˆ†åŒºä¸­çš„æ¯ä¸ªåº“ä½ç½®ï¼ˆbin partitionï¼‰å¢åŠ äº†ä¸€ä¸ªåç§»é‡ã€‚ç±»ä¼¼åœ°ï¼Œåç§»æ˜¯ä»å‰é¢çš„ç‰¹å¾å›¾å’Œæ„Ÿå…´è¶£åŒºåŸŸä¸­å­¦ä¹ çš„ï¼Œä»è€Œèƒ½å¤Ÿå¯¹å…·æœ‰ä¸åŒå½¢çŠ¶çš„å¯¹è±¡è¿›è¡Œè‡ªé€‚åº”éƒ¨ä»¶å®šä½ï¼ˆadaptive part localizationï¼‰ã€‚

#### Deformable Convolutional Networks
Deformable Convolution
2Då·ç§¯ç”±ä¸¤ä¸ªæ­¥éª¤ç»„æˆï¼š
1ï¼‰åœ¨è¾“å…¥ç‰¹å¾å›¾x xxä¸Šä½¿ç”¨è§„åˆ™ç½‘æ ¼R RRè¿›è¡Œé‡‡æ ·ã€‚
2ï¼‰æŠŠè¿™äº›é‡‡æ ·ç‚¹ä¹˜ä¸åŒæƒé‡w wwåç›¸åŠ ã€‚

ç½‘æ ¼Rå®šä¹‰æ„Ÿå—é‡å¤§å°å’Œæ‰©å¼ ç¨‹åº¦ï¼Œæ¯”å¦‚å†…æ ¸å¤§å°ä¸º3x3ï¼Œæ‰©å¼ ç¨‹åº¦ä¸º1çš„ç½‘æ ¼Rå¯ä»¥è¡¨ç¤ºä¸ºï¼š
R = { ( âˆ’ 1 , âˆ’ 1 ) , ( âˆ’ 1 , 0 ) , â€¦ , ( 0 , 1 ) , ( 1 , 1 ) } R = \{(-1,-1),(-1,0),\dots,(0,1),(1,1)\}
R={(âˆ’1,âˆ’1),(âˆ’1,0),â€¦,(0,1),(1,1)}

â€‹
 ä¸€èˆ¬ä¸ºå°æ•°ï¼Œä½¿ç”¨åŒçº¿æ€§æ’å€¼è¿›è¡Œå¤„ç†ã€‚ï¼ˆæŠŠå°æ•°åæ ‡åˆ†è§£åˆ°ç›¸é‚»çš„å››ä¸ªæ•´æ•°åæ ‡ç‚¹æ¥è®¡ç®—ç»“æœï¼‰
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/43928250733543c89a9d4a3c18bd190e.png)

å…·ä½“æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/a400582501324d819f5d8e07599c7827.png)

é¦–å…ˆå¯¹è¾“å…¥ç‰¹å¾å±‚è¿›è¡Œä¸€ä¸ªæ™®é€šçš„3x3å·ç§¯å¤„ç†å¾—åˆ°åç§»åŸŸï¼ˆoffset fieldï¼‰ã€‚åç§»åŸŸç‰¹å¾å›¾å…·æœ‰ä¸è¾“å…¥ç‰¹å¾å›¾ç›¸åŒçš„ç©ºé—´åˆ†è¾¨ç‡ï¼Œchannelsç»´åº¦2Nå¯¹åº”äºNä¸ª2Dï¼ˆxyä¸¤ä¸ªæ–¹å‘ï¼‰åç§»ã€‚å…¶ä¸­çš„Næ˜¯åŸè¾“å…¥ç‰¹å¾å›¾ä¸Šæ‰€å…·æœ‰çš„Nä¸ªchannelsï¼Œä¹Ÿå°±æ˜¯è¾“å…¥è¾“å‡ºchannelsä¿æŒä¸å˜ï¼Œè¿™é‡Œxyä¸¤ä¸ªchannelsåˆ†åˆ«å¯¹è¾“å‡ºç‰¹å¾å›¾ä¸Šçš„ä¸€ä¸ªchannelsè¿›è¡Œåç§»ã€‚ç¡®å®šé‡‡æ ·ç‚¹åå°±é€šè¿‡ä¸ç›¸å¯¹åº”çš„æƒé‡wç‚¹ä¹˜ç›¸åŠ å¾—åˆ°è¾“å‡ºç‰¹å¾å›¾ä¸Šè¯¥ç‚¹æœ€ç»ˆå€¼ã€‚

å‰é¢ä¹Ÿæåˆ°è¿‡ï¼Œç”±äºè¿™é‡Œxyä¸¤ä¸ªæ–¹å‘æ‰€è®­ç»ƒå‡ºæ¥çš„åç§»é‡ä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªå°æ•°ï¼Œé‚£ä¹ˆä¸ºäº†å¾—åˆ°è¿™ä¸ªç‚¹æ‰€å¯¹åº”çš„æ•°å€¼ï¼Œä¼šé‡‡ç”¨åŒçº¿æ€§æ’å€¼çš„æ–¹æ³•ï¼Œä»æœ€è¿‘çš„å››ä¸ªé‚»è¿‘åæ ‡ç‚¹ä¸­è®¡ç®—å¾—åˆ°è¯¥åç§»ç‚¹çš„æ•°å€¼ï¼Œå…¬å¼å¦‚ä¸‹ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/f55ea139adcb434eadb735d4f936a555.png)

å…·ä½“æ¨ç†è¿‡ç¨‹è§ï¼šåŒçº¿æ€§æ’å€¼åŸç†

#### Deformable RoI Poolingb
æ‰€æœ‰åŸºäºåŒºåŸŸæè®®ï¼ˆRPNï¼‰çš„å¯¹è±¡æ£€æµ‹æ–¹æ³•éƒ½ä½¿ç”¨RoIæ± è¯å¤„ç†ï¼Œå°†ä»»æ„å¤§å°çš„è¾“å…¥çŸ©å½¢åŒºåŸŸè½¬æ¢ä¸ºå›ºå®šå¤§å°çš„ç‰¹å¾å›¾ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/ecb969ec7b9b4fc08403dd005b4d40b9.png)

 ä¸€èˆ¬ä¸ºå°æ•°ï¼Œéœ€è¦ä½¿ç”¨åŒçº¿æ€§æ’å€¼è¿›è¡Œå¤„ç†ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/beffd9b7e9164bf2a8780191f0d5163f.png)

å…·ä½“æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/edce7c175c224e308f4e7ab3cd89cc1b.png)


å½“æ—¶çœ‹è¿™ä¸ªéƒ¨åˆ†çš„æ—¶å€™è§‰å¾—æœ‰äº›çªå…€ï¼Œæ˜æ˜RoIæ± åŒ–ä¼šå°†ç‰¹å¾å±‚è½¬åŒ–ä¸ºå›ºå®šå°ºå¯¸çš„åŒºåŸŸã€‚å…¶å®ï¼Œæˆ‘ä¸ªäººè§‰å¾—ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸ä¸Šè¿°çš„å¯å˜æ€§å·ç§¯æ“ä½œæ˜¯ç±»ä¼¼çš„ã€‚è¿™é‡ŒåŒæ ·æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ™®é€šçš„RoIæ± åŒ–æ“ä½œï¼Œè¿›è¡Œä¸€äº›åˆ—å¤„ç†åå¾—åˆ°äº†ä¸€ä¸ªåç§»åŸŸç‰¹å¾å›¾ï¼Œç„¶åé‡æ–°ä½œç”¨äºåŸæ¥çš„w Ã— H w \times HwÃ—Hçš„RoIã€‚åªä¸è¿‡è¿™é‡Œä¸å†æ˜¯è§„å¾‹çš„é€è¡Œé€åˆ—å¯¹æ¯ä¸ªæ ¼å­è¿›è¡Œæ± åŒ–ï¼Œè€Œæ˜¯å¯¹äºæ ¼å­è¿›è¡Œåç§»åå†æ± åŒ–å¤„ç†ã€‚

#### Postionï¹£Sensitive RoI Pooling
é™¤æ­¤ä¹‹å¤–ï¼Œè®ºæ–‡è¿˜æå‡ºä¸€ç§PS RoIæ± åŒ–ï¼ˆPostionï¹£Sensitive RoI Poolingï¼‰ã€‚ä¸åŒäºä¸Šè¿°å¯å˜å½¢RoIæ± åŒ–ä¸­çš„å…¨è¿æ¥è¿‡ç¨‹ï¼Œè¿™é‡Œä½¿ç”¨å…¨å·ç§¯æ›¿æ¢ã€‚

å…·ä½“æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/8fc3618147e24e69b84b65477a3c18b1.png)

é¦–å…ˆï¼Œå¯¹äºåŸæ¥çš„ç‰¹å¾å›¾æ¥è¯´ï¼ŒåŸæœ¬æ˜¯å°†è¾“å…¥ç‰¹å¾å›¾ä¸Šçš„RoIåŒºåŸŸåˆ†æˆk Ã— k k\times kkÃ—kä¸ªbinã€‚è€Œåœ¨è¿™é‡Œï¼Œåˆ™æ˜¯å°†è¾“å…¥ç‰¹å¾å›¾è¿›è¡Œå·ç§¯æ“ä½œï¼Œåˆ†åˆ«å¾—åˆ°ä¸€ä¸ªchannelsä¸ºk 2 ( C + 1 ) k^{2}(C+1)k (C+1)çš„å¾—åˆ†å›¾ï¼ˆscore mapsï¼‰å’Œä¸€ä¸ªchannelsä¸º2 k 2 ( C + 1 ) 2k{2}(C+1)2k 2 (C+1)çš„åç§»åŸŸï¼ˆoffset fieldsï¼‰ï¼Œè¿™ä¸¤ä¸ªç‰¹å¾çŸ©é˜µçš„å®½é«˜æ˜¯ä¸è¾“å…¥ç‰¹å¾çŸ©é˜µç›¸åŒçš„ã€‚å…¶ä¸­ï¼Œå¾—åˆ†å›¾çš„channelsä¸­ï¼Œk Ã— k k \times kkÃ—kåˆ†åˆ«è¡¨ç¤ºçš„æ˜¯æ¯ä¸€ä¸ªç½‘æ ¼ï¼ŒC CCè¡¨ç¤ºçš„æ£€æµ‹å¯¹è±¡çš„ç±»åˆ«æ•°ç›®ï¼Œ1è¡¨ç¤ºèƒŒæ™¯ã€‚è€Œåœ¨åç§»åŸŸä¸­çš„2è¡¨ç¤ºxyä¸¤ä¸ªæ–¹å‘çš„åç§»ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨PS RoIæ± åŒ–ä¸­ï¼Œå¯¹äºRoIçš„æ¯ä¸€ä¸ªç½‘æ ¼éƒ½ç‹¬è‡ªå ä¸€ä¸ªé€šé“å½¢æˆä¸€å±‚å¾—åˆ†å›¾ï¼Œç„¶åå…¶å¯¹äºçš„åç§»é‡å ä¸¤ä¸ªé€šé“ã€‚offset fieldså¾—åˆ°çš„åç§»æ˜¯å½’ä¸€åŒ–åçš„åç§»ï¼Œéœ€è¦é€šè¿‡å’Œdeformable RoI poolingä¸­ä¸€æ ·çš„å˜æ¢æ–¹å¼å¾—åˆ°âˆ† p i j âˆ†p_{ij}âˆ†p ijï¼Œç„¶åå¯¹æ¯å±‚å¾—åˆ†å›¾è¿›è¡Œåç§»æ± åŒ–å¤„ç†ã€‚æœ€åå¤„ç†å®Œçš„ç»“æœå°±å¯¹åº”ç€æœ€åè¾“å‡ºçš„ä¸€ä¸ªç½‘æ ¼ã€‚æ‰€ä»¥å…¶åŒ…å«äº†ä½ç½®ä¿¡æ¯ã€‚

åŸæ–‡è®ºè¿°ä¸ºï¼š


#### Understanding Deformable ConvNets
å½“å¯å˜å½¢å·ç§¯å åŠ æ—¶ï¼Œå¤åˆå˜å½¢çš„æ•ˆæœæ˜¯æ·±è¿œçš„ã€‚å¦‚å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/245b1c99722548e6b493b4e7337629dc.png)

psï¼šaæ˜¯æ ‡å‡†å·ç§¯çš„å›ºå®šæ„Ÿå—é‡ï¼Œbæ˜¯å¯å˜å½¢å·ç§¯çš„é€‚åº”æ€§æ„Ÿå—é‡ã€‚

æ„Ÿå—é‡å’Œæ ‡å‡†å·ç§¯ä¸­çš„é‡‡æ ·ä½ç½®åœ¨æ•´ä¸ªé¡¶éƒ¨ç‰¹å¾å›¾ä¸Šæ˜¯å›ºå®šçš„(å·¦)ã€‚åœ¨å¯å˜å½¢å·ç§¯ä¸­ï¼Œå®ƒä»¬æ ¹æ®å¯¹è±¡çš„æ¯”ä¾‹å’Œå½¢çŠ¶è¿›è¡Œè‡ªé€‚åº”è°ƒæ•´(å³)ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/eea4ed8068e84ccf8cdba4edcacd0889.png)



### 11.é¡¹ç›®æ ¸å¿ƒæºç è®²è§£ï¼ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒçœ‹ä¸æ‡‚ä»£ç é€»è¾‘ï¼‰

#### 11.1 ultralytics\models\__init__.py

ä¸‹é¢æ˜¯å¯¹ç»™å®šä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†è¿›è¡Œåˆ†æå’Œè¯¦ç»†æ³¨é‡Šçš„ç»“æœï¼š

```python
# Ultralytics YOLO ğŸš€, AGPL-3.0 license

# ä»å½“å‰åŒ…ä¸­å¯¼å…¥ RTDETRã€SAM å’Œ YOLO ç±»
from .rtdetr import RTDETR  # å¯¼å…¥ RTDETR ç±»ï¼Œç”¨äºå®æ—¶ç›®æ ‡æ£€æµ‹
from .sam import SAM        # å¯¼å…¥ SAM ç±»ï¼Œå¯èƒ½ç”¨äºå›¾åƒåˆ†å‰²æˆ–å…¶ä»–ä»»åŠ¡
from .yolo import YOLO      # å¯¼å…¥ YOLO ç±»ï¼Œè¿›è¡Œç›®æ ‡æ£€æµ‹

# å®šä¹‰æ¨¡å—çš„å…¬å¼€æ¥å£ï¼Œå…è®¸å…¶ä»–æ¨¡å—ä»¥æ›´ç®€å•çš„æ–¹å¼å¯¼å…¥è¿™äº›ç±»
__all__ = 'YOLO', 'RTDETR', 'SAM'  # å…¬å¼€çš„ç±»åˆ—è¡¨
```

### ä»£ç åˆ†æ

1. **å¯¼å…¥æ¨¡å—**ï¼š
   - `from .rtdetr import RTDETR`ï¼šä»å½“å‰åŒ…ä¸­å¯¼å…¥ `RTDETR` ç±»ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªç”¨äºå®æ—¶ç›®æ ‡æ£€æµ‹çš„å®ç°ã€‚
   - `from .sam import SAM`ï¼šä»å½“å‰åŒ…ä¸­å¯¼å…¥ `SAM` ç±»ï¼Œå¯èƒ½ç”¨äºå›¾åƒåˆ†å‰²æˆ–å…¶ä»–ç›¸å…³ä»»åŠ¡ã€‚
   - `from .yolo import YOLO`ï¼šä»å½“å‰åŒ…ä¸­å¯¼å…¥ `YOLO` ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªæµè¡Œçš„ç›®æ ‡æ£€æµ‹ç®—æ³•ã€‚

2. **`__all__` çš„å®šä¹‰**ï¼š
   - `__all__` æ˜¯ä¸€ä¸ªç‰¹æ®Šå˜é‡ï¼Œç”¨äºå®šä¹‰å½“ä½¿ç”¨ `from module import *` æ—¶ï¼Œå“ªäº›åç§°ä¼šè¢«å¯¼å…¥ã€‚è¿™é‡Œå®šä¹‰äº† `YOLO`ã€`RTDETR` å’Œ `SAM` ä¸‰ä¸ªç±»ï¼Œæ„å‘³ç€è¿™ä¸‰ä¸ªç±»æ˜¯æ¨¡å—çš„æ ¸å¿ƒåŠŸèƒ½éƒ¨åˆ†ï¼Œå…¶ä»–ç±»æˆ–å‡½æ•°ä¸ä¼šè¢«å¯¼å…¥ã€‚

### æ€»ç»“
è¿™æ®µä»£ç ä¸»è¦ç”¨äºæ¨¡å—çš„ç»„ç»‡å’Œæ¥å£å®šä¹‰ï¼Œç¡®ä¿åœ¨ä½¿ç”¨è¯¥æ¨¡å—æ—¶ï¼Œç”¨æˆ·èƒ½å¤Ÿæ–¹ä¾¿åœ°è®¿é—®æ ¸å¿ƒåŠŸèƒ½ç±»ã€‚

è¿™ä¸ªæ–‡ä»¶æ˜¯Ultralytics YOLOé¡¹ç›®ä¸­çš„ä¸€ä¸ªåˆå§‹åŒ–æ–‡ä»¶ï¼Œä½äº`ultralytics/models`ç›®å½•ä¸‹ã€‚æ–‡ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯å¯¼å…¥å’Œå®šä¹‰è¯¥æ¨¡å—ä¸­å¯ç”¨çš„ç±»æˆ–å‡½æ•°ï¼Œä»¥ä¾¿å…¶ä»–æ¨¡å—å¯ä»¥æ›´æ–¹ä¾¿åœ°ä½¿ç”¨ã€‚

é¦–å…ˆï¼Œæ–‡ä»¶å¼€å¤´çš„æ³¨é‡Šè¡¨æ˜è¿™æ˜¯Ultralytics YOLOé¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”è¯¥é¡¹ç›®éµå¾ªAGPL-3.0è®¸å¯è¯ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€æºè®¸å¯è¯ï¼Œå…è®¸ç”¨æˆ·è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘è½¯ä»¶ï¼Œä½†è¦æ±‚ä»»ä½•æ´¾ç”Ÿä½œå“ä¹Ÿå¿…é¡»éµå¾ªç›¸åŒçš„è®¸å¯è¯ã€‚

æ¥ä¸‹æ¥ï¼Œæ–‡ä»¶é€šè¿‡ç›¸å¯¹å¯¼å…¥çš„æ–¹å¼å¼•å…¥äº†ä¸‰ä¸ªæ¨¡å‹ç±»ï¼š`RTDETR`ã€`SAM`å’Œ`YOLO`ã€‚è¿™äº›ç±»åˆ†åˆ«å®šä¹‰åœ¨åŒä¸€ç›®å½•ä¸‹çš„ä¸åŒæ–‡ä»¶ä¸­ï¼Œå¯èƒ½ä»£è¡¨ä¸åŒçš„ç›®æ ‡æ£€æµ‹æˆ–åˆ†å‰²æ¨¡å‹ã€‚å…·ä½“æ¥è¯´ï¼š

- `RTDETR`å¯èƒ½æ˜¯ä¸€ä¸ªåŸºäºDETRï¼ˆDetection Transformerï¼‰çš„å®æ—¶ç›®æ ‡æ£€æµ‹æ¨¡å‹ã€‚
- `SAM`å¯èƒ½æ˜¯ä¸€ä¸ªåˆ†å‰²æ¨¡å‹ï¼Œå…·ä½“åŠŸèƒ½éœ€è¦æŸ¥çœ‹å…¶å®šä¹‰ã€‚
- `YOLO`åˆ™æ˜¯è‘—åçš„â€œä½ åªçœ‹ä¸€æ¬¡â€ï¼ˆYou Only Look Onceï¼‰ç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼Œå¹¿æ³›åº”ç”¨äºå®æ—¶ç›®æ ‡æ£€æµ‹ä»»åŠ¡ã€‚

æœ€åï¼Œ`__all__`å˜é‡å®šä¹‰äº†è¯¥æ¨¡å—çš„å…¬å…±æ¥å£ï¼Œåˆ—å‡ºäº†å¯ä»¥é€šè¿‡`from ultralytics.models import *`è¯­å¥å¯¼å…¥çš„ç±»ã€‚è¿™æ„å‘³ç€åœ¨å…¶ä»–æ–‡ä»¶ä¸­ï¼Œå¦‚æœä½¿ç”¨è¿™ç§å¯¼å…¥æ–¹å¼ï¼Œåªä¼šå¯¼å…¥`YOLO`ã€`RTDETR`å’Œ`SAM`è¿™ä¸‰ä¸ªç±»ï¼Œè€Œä¸ä¼šå¯¼å…¥è¯¥æ¨¡å—ä¸­å¯èƒ½å­˜åœ¨çš„å…¶ä»–ç§æœ‰ç±»æˆ–å‡½æ•°ã€‚

æ€»ä½“è€Œè¨€ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨æ˜¯ç»„ç»‡å’Œç®€åŒ–æ¨¡å‹çš„å¯¼å…¥ï¼Œä½¿å¾—ä½¿ç”¨è€…å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å’Œä½¿ç”¨è¿™äº›æ¨¡å‹ã€‚

#### 11.2 ultralytics\models\sam\build.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import torch
from ultralytics.utils.downloads import attempt_download_asset
from .modules.decoders import MaskDecoder
from .modules.encoders import ImageEncoderViT, PromptEncoder
from .modules.sam import Sam
from .modules.tiny_encoder import TinyViT
from .modules.transformer import TwoWayTransformer

def _build_sam(encoder_embed_dim,
               encoder_depth,
               encoder_num_heads,
               encoder_global_attn_indexes,
               checkpoint=None,
               mobile_sam=False):
    """æ„å»ºæ‰€é€‰çš„SAMæ¨¡å‹æ¶æ„ã€‚"""
    
    # å®šä¹‰æç¤ºåµŒå…¥ç»´åº¦å’Œå›¾åƒå°ºå¯¸
    prompt_embed_dim = 256
    image_size = 1024
    vit_patch_size = 16
    image_embedding_size = image_size // vit_patch_size  # è®¡ç®—å›¾åƒåµŒå…¥å°ºå¯¸

    # æ ¹æ®æ˜¯å¦ä¸ºç§»åŠ¨SAMé€‰æ‹©ä¸åŒçš„å›¾åƒç¼–ç å™¨
    image_encoder = (TinyViT(
        img_size=1024,
        in_chans=3,
        num_classes=1000,
        embed_dims=encoder_embed_dim,
        depths=encoder_depth,
        num_heads=encoder_num_heads,
        window_sizes=[7, 7, 14, 7],
        mlp_ratio=4.0,
        drop_rate=0.0,
        drop_path_rate=0.0,
        use_checkpoint=False,
        mbconv_expand_ratio=4.0,
        local_conv_size=3,
    ) if mobile_sam else ImageEncoderViT(
        depth=encoder_depth,
        embed_dim=encoder_embed_dim,
        img_size=image_size,
        mlp_ratio=4,
        norm_layer=partial(torch.nn.LayerNorm, eps=1e-6),
        num_heads=encoder_num_heads,
        patch_size=vit_patch_size,
        qkv_bias=True,
        use_rel_pos=True,
        global_attn_indexes=encoder_global_attn_indexes,
        window_size=14,
        out_chans=prompt_embed_dim,
    ))

    # åˆ›å»ºSAMæ¨¡å‹
    sam = Sam(
        image_encoder=image_encoder,  # å›¾åƒç¼–ç å™¨
        prompt_encoder=PromptEncoder(
            embed_dim=prompt_embed_dim,
            image_embedding_size=(image_embedding_size, image_embedding_size),
            input_image_size=(image_size, image_size),
            mask_in_chans=16,
        ),
        mask_decoder=MaskDecoder(
            num_multimask_outputs=3,
            transformer=TwoWayTransformer(
                depth=2,
                embedding_dim=prompt_embed_dim,
                mlp_dim=2048,
                num_heads=8,
            ),
            transformer_dim=prompt_embed_dim,
            iou_head_depth=3,
            iou_head_hidden_dim=256,
        ),
        pixel_mean=[123.675, 116.28, 103.53],  # åƒç´ å‡å€¼
        pixel_std=[58.395, 57.12, 57.375],      # åƒç´ æ ‡å‡†å·®
    )

    # å¦‚æœæä¾›äº†æ£€æŸ¥ç‚¹ï¼Œåˆ™åŠ è½½æ¨¡å‹æƒé‡
    if checkpoint is not None:
        checkpoint = attempt_download_asset(checkpoint)  # å°è¯•ä¸‹è½½æ£€æŸ¥ç‚¹
        with open(checkpoint, 'rb') as f:
            state_dict = torch.load(f)  # åŠ è½½æƒé‡
        sam.load_state_dict(state_dict)  # å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­

    sam.eval()  # è®¾ç½®æ¨¡å‹ä¸ºè¯„ä¼°æ¨¡å¼
    return sam  # è¿”å›æ„å»ºçš„SAMæ¨¡å‹
```

### ä»£ç è¯´æ˜ï¼š
1. **å¯¼å…¥æ¨¡å—**ï¼šå¯¼å…¥å¿…è¦çš„åº“å’Œæ¨¡å—ï¼ŒåŒ…æ‹¬PyTorchå’Œè‡ªå®šä¹‰çš„æ¨¡å‹ç»„ä»¶ã€‚
2. **_build_samå‡½æ•°**ï¼šè¿™æ˜¯æ„å»ºSAMæ¨¡å‹çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ¥å—å¤šä¸ªå‚æ•°ä»¥é…ç½®æ¨¡å‹çš„ä¸åŒéƒ¨åˆ†ã€‚
   - **å‚æ•°è¯´æ˜**ï¼š
     - `encoder_embed_dim`ï¼šç¼–ç å™¨çš„åµŒå…¥ç»´åº¦ã€‚
     - `encoder_depth`ï¼šç¼–ç å™¨çš„æ·±åº¦ã€‚
     - `encoder_num_heads`ï¼šç¼–ç å™¨çš„å¤´æ•°ã€‚
     - `encoder_global_attn_indexes`ï¼šå…¨å±€æ³¨æ„åŠ›ç´¢å¼•ã€‚
     - `checkpoint`ï¼šå¯é€‰çš„æ¨¡å‹æ£€æŸ¥ç‚¹ï¼Œç”¨äºåŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚
     - `mobile_sam`ï¼šå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦æ„å»ºç§»åŠ¨ç‰ˆæœ¬çš„SAMã€‚
3. **å›¾åƒç¼–ç å™¨é€‰æ‹©**ï¼šæ ¹æ®`mobile_sam`çš„å€¼é€‰æ‹©ä¸åŒçš„å›¾åƒç¼–ç å™¨ï¼ˆTinyViTæˆ–ImageEncoderViTï¼‰ã€‚
4. **åˆ›å»ºSAMæ¨¡å‹**ï¼šä½¿ç”¨æŒ‡å®šçš„ç¼–ç å™¨å’Œè§£ç å™¨æ„å»ºSAMæ¨¡å‹ã€‚
5. **åŠ è½½æ£€æŸ¥ç‚¹**ï¼šå¦‚æœæä¾›äº†æ£€æŸ¥ç‚¹ï¼Œå°è¯•ä¸‹è½½å¹¶åŠ è½½æ¨¡å‹æƒé‡ã€‚
6. **è®¾ç½®è¯„ä¼°æ¨¡å¼**ï¼šå°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ï¼Œä»¥ä¾¿è¿›è¡Œæ¨ç†ã€‚

é€šè¿‡è¿™äº›æ­¥éª¤ï¼Œä»£ç å®ç°äº†æ„å»ºå’Œé…ç½®Segment Anything Model (SAM)çš„åŠŸèƒ½ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯æ„å»ºä¸åŒå°ºå¯¸çš„â€œSegment Anything Modelâ€ï¼ˆSAMï¼‰æ¨¡å‹ï¼Œæä¾›äº†å¤šç§æ„å»ºé€‰é¡¹ï¼ŒåŒ…æ‹¬å¤§ã€ä¸­ã€å°å‹æ¨¡å‹ä»¥åŠç§»åŠ¨ç‰ˆæœ¬çš„æ¨¡å‹ã€‚æ–‡ä»¶ä¸­ä½¿ç”¨äº†PyTorchåº“æ¥å®ç°æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ„å»ºå’ŒåŠ è½½ã€‚

é¦–å…ˆï¼Œæ–‡ä»¶å¼•å…¥äº†ä¸€äº›å¿…è¦çš„åº“å’Œæ¨¡å—ï¼ŒåŒ…æ‹¬`torch`å’Œä¸€äº›è‡ªå®šä¹‰çš„æ¨¡å—ï¼Œå¦‚`MaskDecoder`ã€`ImageEncoderViT`ã€`PromptEncoder`ã€`Sam`ã€`TinyViT`å’Œ`TwoWayTransformer`ã€‚è¿™äº›æ¨¡å—åˆ†åˆ«è´Ÿè´£æ¨¡å‹çš„ä¸åŒéƒ¨åˆ†ï¼Œå¦‚å›¾åƒç¼–ç ã€æç¤ºç¼–ç å’Œæ©ç è§£ç ã€‚

æ¥ä¸‹æ¥ï¼Œæ–‡ä»¶å®šä¹‰äº†å¤šä¸ªæ„å»ºå‡½æ•°ï¼Œåˆ†åˆ«ç”¨äºæ„å»ºä¸åŒå°ºå¯¸çš„SAMæ¨¡å‹ã€‚è¿™äº›å‡½æ•°åŒ…æ‹¬`build_sam_vit_h`ã€`build_sam_vit_l`ã€`build_sam_vit_b`å’Œ`build_mobile_sam`ã€‚æ¯ä¸ªå‡½æ•°è°ƒç”¨äº†ä¸€ä¸ªç§æœ‰å‡½æ•°`_build_sam`ï¼Œå¹¶ä¼ å…¥ç‰¹å®šçš„å‚æ•°ï¼Œå¦‚ç¼–ç å™¨çš„åµŒå…¥ç»´åº¦ã€æ·±åº¦ã€å¤´æ•°ç­‰ã€‚è¿™äº›å‚æ•°å†³å®šäº†æ¨¡å‹çš„ç»“æ„å’Œå¤æ‚åº¦ã€‚

`_build_sam`å‡½æ•°æ˜¯æ„å»ºSAMæ¨¡å‹çš„æ ¸å¿ƒå‡½æ•°ã€‚å®ƒé¦–å…ˆå®šä¹‰äº†ä¸€äº›å›ºå®šçš„å‚æ•°ï¼Œå¦‚æç¤ºåµŒå…¥ç»´åº¦ã€å›¾åƒå¤§å°å’Œè¡¥ä¸å¤§å°ã€‚ç„¶åï¼Œæ ¹æ®æ˜¯å¦æ„å»ºç§»åŠ¨ç‰ˆæœ¬çš„æ¨¡å‹ï¼Œé€‰æ‹©åˆé€‚çš„å›¾åƒç¼–ç å™¨ï¼ˆ`TinyViT`æˆ–`ImageEncoderViT`ï¼‰ã€‚æ¥ç€ï¼Œåˆ›å»ºäº†SAMæ¨¡å‹çš„å®ä¾‹ï¼ŒåŒ…æ‹¬å›¾åƒç¼–ç å™¨ã€æç¤ºç¼–ç å™¨å’Œæ©ç è§£ç å™¨ã€‚æ©ç è§£ç å™¨ä¸­ä½¿ç”¨äº†åŒå‘å˜æ¢å™¨ï¼ˆ`TwoWayTransformer`ï¼‰æ¥å¤„ç†å¤šæ©ç è¾“å‡ºã€‚

å¦‚æœæä¾›äº†æ£€æŸ¥ç‚¹è·¯å¾„ï¼Œç¨‹åºä¼šå°è¯•ä¸‹è½½å¹¶åŠ è½½æ¨¡å‹çš„é¢„è®­ç»ƒæƒé‡ã€‚æœ€åï¼Œæ¨¡å‹è¢«è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ï¼Œå¹¶è¿”å›æ„å»ºå¥½çš„æ¨¡å‹å®ä¾‹ã€‚

åœ¨æ–‡ä»¶çš„æœ€åéƒ¨åˆ†ï¼Œå®šä¹‰äº†ä¸€ä¸ªå­—å…¸`samm_model_map`ï¼Œå°†æ¨¡å‹æ–‡ä»¶åæ˜ å°„åˆ°ç›¸åº”çš„æ„å»ºå‡½æ•°ã€‚`build_sam`å‡½æ•°æ ¹æ®ç»™å®šçš„æ£€æŸ¥ç‚¹åç§°é€‰æ‹©åˆé€‚çš„æ„å»ºå‡½æ•°ï¼Œå¹¶è¿”å›æ„å»ºå¥½çš„æ¨¡å‹ã€‚å¦‚æœæä¾›çš„æ£€æŸ¥ç‚¹ä¸åœ¨æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ä¸­ï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªæ–‡ä»¶æœªæ‰¾åˆ°çš„å¼‚å¸¸ã€‚

æ€»ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä¸»è¦ç›®çš„æ˜¯æä¾›ä¸€ç§çµæ´»çš„æ–¹å¼æ¥æ„å»ºå’ŒåŠ è½½ä¸åŒé…ç½®çš„SAMæ¨¡å‹ï¼Œä»¥ä¾¿åœ¨å›¾åƒåˆ†å‰²ç­‰ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚

#### 11.3 ultralytics\trackers\utils\matching.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import numpy as np
import scipy
from scipy.spatial.distance import cdist
from ultralytics.utils.metrics import bbox_ioa

try:
    import lap  # å¯¼å…¥çº¿æ€§åˆ†é…åº“
    assert lap.__version__  # ç¡®ä¿å¯¼å…¥çš„åŒ…ä¸æ˜¯ç›®å½•
except (ImportError, AssertionError, AttributeError):
    from ultralytics.utils.checks import check_requirements
    check_requirements('lapx>=0.5.2')  # æ£€æŸ¥å¹¶æ›´æ–°åˆ°lapåŒ…
    import lap


def linear_assignment(cost_matrix, thresh, use_lap=True):
    """
    ä½¿ç”¨çº¿æ€§åˆ†é…ç®—æ³•è¿›è¡ŒåŒ¹é…ã€‚

    å‚æ•°:
        cost_matrix (np.ndarray): åŒ…å«åˆ†é…æˆæœ¬çš„çŸ©é˜µã€‚
        thresh (float): è®¤ä¸ºåˆ†é…æœ‰æ•ˆçš„é˜ˆå€¼ã€‚
        use_lap (bool, optional): æ˜¯å¦ä½¿ç”¨lap.lapjvã€‚é»˜è®¤ä¸ºTrueã€‚

    è¿”å›:
        (tuple): åŒ…å«åŒ¹é…ç´¢å¼•ã€æœªåŒ¹é…çš„ç´¢å¼•ï¼ˆæ¥è‡ª'a'ï¼‰å’ŒæœªåŒ¹é…çš„ç´¢å¼•ï¼ˆæ¥è‡ª'b'ï¼‰çš„å…ƒç»„ã€‚
    """
    # å¦‚æœæˆæœ¬çŸ©é˜µä¸ºç©ºï¼Œè¿”å›ç©ºåŒ¹é…å’Œæ‰€æœ‰æœªåŒ¹é…ç´¢å¼•
    if cost_matrix.size == 0:
        return np.empty((0, 2), dtype=int), tuple(range(cost_matrix.shape[0])), tuple(range(cost_matrix.shape[1]))

    if use_lap:
        # ä½¿ç”¨lapåº“è¿›è¡Œçº¿æ€§åˆ†é…
        _, x, y = lap.lapjv(cost_matrix, extend_cost=True, cost_limit=thresh)
        matches = [[ix, mx] for ix, mx in enumerate(x) if mx >= 0]  # æ‰¾åˆ°åŒ¹é…çš„ç´¢å¼•
        unmatched_a = np.where(x < 0)[0]  # æ‰¾åˆ°æœªåŒ¹é…çš„'a'ç´¢å¼•
        unmatched_b = np.where(y < 0)[0]  # æ‰¾åˆ°æœªåŒ¹é…çš„'b'ç´¢å¼•
    else:
        # ä½¿ç”¨scipyè¿›è¡Œçº¿æ€§åˆ†é…
        x, y = scipy.optimize.linear_sum_assignment(cost_matrix)  # è¡Œxï¼Œåˆ—y
        matches = np.asarray([[x[i], y[i]] for i in range(len(x)) if cost_matrix[x[i], y[i]] <= thresh])
        if len(matches) == 0:
            unmatched_a = list(np.arange(cost_matrix.shape[0]))
            unmatched_b = list(np.arange(cost_matrix.shape[1]))
        else:
            unmatched_a = list(set(np.arange(cost_matrix.shape[0])) - set(matches[:, 0]))
            unmatched_b = list(set(np.arange(cost_matrix.shape[1])) - set(matches[:, 1]))

    return matches, unmatched_a, unmatched_b  # è¿”å›åŒ¹é…ç»“æœå’ŒæœªåŒ¹é…ç´¢å¼•


def iou_distance(atracks, btracks):
    """
    åŸºäºäº¤å¹¶æ¯”ï¼ˆIoUï¼‰è®¡ç®—è½¨è¿¹ä¹‹é—´çš„æˆæœ¬ã€‚

    å‚æ•°:
        atracks (list[STrack] | list[np.ndarray]): è½¨è¿¹'a'æˆ–è¾¹ç•Œæ¡†çš„åˆ—è¡¨ã€‚
        btracks (list[STrack] | list[np.ndarray]): è½¨è¿¹'b'æˆ–è¾¹ç•Œæ¡†çš„åˆ—è¡¨ã€‚

    è¿”å›:
        (np.ndarray): åŸºäºIoUè®¡ç®—çš„æˆæœ¬çŸ©é˜µã€‚
    """
    # åˆ¤æ–­è¾“å…¥ç±»å‹å¹¶è·å–è¾¹ç•Œæ¡†
    if (len(atracks) > 0 and isinstance(atracks[0], np.ndarray)) \
            or (len(btracks) > 0 and isinstance(btracks[0], np.ndarray)):
        atlbrs = atracks
        btlbrs = btracks
    else:
        atlbrs = [track.tlbr for track in atracks]  # è·å–è½¨è¿¹'a'çš„è¾¹ç•Œæ¡†
        btlbrs = [track.tlbr for track in btracks]  # è·å–è½¨è¿¹'b'çš„è¾¹ç•Œæ¡†

    ious = np.zeros((len(atlbrs), len(btlbrs)), dtype=np.float32)  # åˆå§‹åŒ–IoUçŸ©é˜µ
    if len(atlbrs) and len(btlbrs):
        # è®¡ç®—IoU
        ious = bbox_ioa(np.ascontiguousarray(atlbrs, dtype=np.float32),
                        np.ascontiguousarray(btlbrs, dtype=np.float32),
                        iou=True)
    return 1 - ious  # è¿”å›æˆæœ¬çŸ©é˜µï¼ˆ1 - IoUï¼‰


def embedding_distance(tracks, detections, metric='cosine'):
    """
    åŸºäºåµŒå…¥è®¡ç®—è½¨è¿¹å’Œæ£€æµ‹ä¹‹é—´çš„è·ç¦»ã€‚

    å‚æ•°:
        tracks (list[STrack]): è½¨è¿¹åˆ—è¡¨ã€‚
        detections (list[BaseTrack]): æ£€æµ‹åˆ—è¡¨ã€‚
        metric (str, optional): è·ç¦»è®¡ç®—çš„åº¦é‡ã€‚é»˜è®¤ä¸º'cosine'ã€‚

    è¿”å›:
        (np.ndarray): åŸºäºåµŒå…¥è®¡ç®—çš„æˆæœ¬çŸ©é˜µã€‚
    """
    cost_matrix = np.zeros((len(tracks), len(detections)), dtype=np.float32)  # åˆå§‹åŒ–æˆæœ¬çŸ©é˜µ
    if cost_matrix.size == 0:
        return cost_matrix  # å¦‚æœæˆæœ¬çŸ©é˜µä¸ºç©ºï¼Œç›´æ¥è¿”å›

    det_features = np.asarray([track.curr_feat for track in detections], dtype=np.float32)  # è·å–æ£€æµ‹ç‰¹å¾
    track_features = np.asarray([track.smooth_feat for track in tracks], dtype=np.float32)  # è·å–è½¨è¿¹ç‰¹å¾
    cost_matrix = np.maximum(0.0, cdist(track_features, det_features, metric))  # è®¡ç®—è·ç¦»å¹¶ç¡®ä¿éè´Ÿ
    return cost_matrix  # è¿”å›æˆæœ¬çŸ©é˜µ


def fuse_score(cost_matrix, detections):
    """
    å°†æˆæœ¬çŸ©é˜µä¸æ£€æµ‹åˆ†æ•°èåˆä»¥ç”Ÿæˆå•ä¸€ç›¸ä¼¼åº¦çŸ©é˜µã€‚

    å‚æ•°:
        cost_matrix (np.ndarray): åŒ…å«åˆ†é…æˆæœ¬çš„çŸ©é˜µã€‚
        detections (list[BaseTrack]): å¸¦æœ‰åˆ†æ•°çš„æ£€æµ‹åˆ—è¡¨ã€‚

    è¿”å›:
        (np.ndarray): èåˆåçš„ç›¸ä¼¼åº¦çŸ©é˜µã€‚
    """
    if cost_matrix.size == 0:
        return cost_matrix  # å¦‚æœæˆæœ¬çŸ©é˜µä¸ºç©ºï¼Œç›´æ¥è¿”å›

    iou_sim = 1 - cost_matrix  # å°†æˆæœ¬çŸ©é˜µè½¬æ¢ä¸ºç›¸ä¼¼åº¦çŸ©é˜µ
    det_scores = np.array([det.score for det in detections])  # è·å–æ£€æµ‹åˆ†æ•°
    det_scores = np.expand_dims(det_scores, axis=0).repeat(cost_matrix.shape[0], axis=0)  # æ‰©å±•åˆ†æ•°ç»´åº¦
    fuse_sim = iou_sim * det_scores  # èåˆç›¸ä¼¼åº¦
    return 1 - fuse_sim  # è¿”å›èåˆåçš„æˆæœ¬çŸ©é˜µ
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è§£é‡Šï¼š
1. **çº¿æ€§åˆ†é…**ï¼š`linear_assignment` å‡½æ•°ä½¿ç”¨æˆæœ¬çŸ©é˜µè¿›è¡ŒåŒ¹é…ï¼Œè¿”å›åŒ¹é…çš„ç´¢å¼•å’ŒæœªåŒ¹é…çš„ç´¢å¼•ã€‚
2. **IoUè®¡ç®—**ï¼š`iou_distance` å‡½æ•°è®¡ç®—è½¨è¿¹ä¹‹é—´çš„äº¤å¹¶æ¯”ï¼Œè¿”å›æˆæœ¬çŸ©é˜µã€‚
3. **åµŒå…¥è·ç¦»**ï¼š`embedding_distance` å‡½æ•°è®¡ç®—è½¨è¿¹å’Œæ£€æµ‹ä¹‹é—´çš„è·ç¦»ï¼ŒåŸºäºç‰¹å¾åµŒå…¥ã€‚
4. **èåˆåˆ†æ•°**ï¼š`fuse_score` å‡½æ•°å°†æˆæœ¬çŸ©é˜µä¸æ£€æµ‹åˆ†æ•°ç»“åˆï¼Œç”Ÿæˆç›¸ä¼¼åº¦çŸ©é˜µã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶ä¸»è¦ç”¨äºå¤„ç†ç›®æ ‡è·Ÿè¸ªä¸­çš„åŒ¹é…é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡è®¡ç®—ä¸åŒç›®æ ‡ä¹‹é—´çš„æˆæœ¬çŸ©é˜µæ¥å®ç°ç›®æ ‡çš„å…³è”ã€‚æ–‡ä»¶ä¸­åŒ…å«äº†å¤šä¸ªå‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰å…¶ç‰¹å®šçš„åŠŸèƒ½ã€‚

é¦–å…ˆï¼Œæ–‡ä»¶å¯¼å…¥äº†å¿…è¦çš„åº“ï¼ŒåŒ…æ‹¬NumPyå’ŒSciPyï¼Œåè€…ç”¨äºè®¡ç®—è·ç¦»ã€‚è¿˜å°è¯•å¯¼å…¥ä¸€ä¸ªåä¸º`lap`çš„åº“ï¼Œè¯¥åº“ç”¨äºçº¿æ€§åˆ†é…ï¼Œå¦‚æœå¯¼å…¥å¤±è´¥ï¼Œåˆ™ä¼šæ£€æŸ¥å¹¶å®‰è£…ç›¸åº”çš„ä¾èµ–ã€‚

`linear_assignment`å‡½æ•°æ˜¯æ ¸å¿ƒå‡½æ•°ä¹‹ä¸€ï¼Œå®ƒæ¥å—ä¸€ä¸ªæˆæœ¬çŸ©é˜µå’Œä¸€ä¸ªé˜ˆå€¼ï¼Œå¹¶æ ¹æ®ç»™å®šçš„å‚æ•°é€‰æ‹©ä½¿ç”¨`lap`åº“æˆ–`scipy`åº“æ¥æ‰§è¡Œçº¿æ€§åˆ†é…ã€‚è¯¥å‡½æ•°è¿”å›åŒ¹é…çš„ç´¢å¼•ã€æœªåŒ¹é…çš„ç´¢å¼•ä»¥åŠæœªåŒ¹é…çš„ç›®æ ‡ã€‚è‹¥æˆæœ¬çŸ©é˜µä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ç©ºçš„åŒ¹é…ç»“æœå’Œæ‰€æœ‰æœªåŒ¹é…çš„ç´¢å¼•ã€‚

`iou_distance`å‡½æ•°ç”¨äºè®¡ç®—ç›®æ ‡ä¹‹é—´çš„é‡å ç¨‹åº¦ï¼Œå…·ä½“æ˜¯é€šè¿‡è®¡ç®—äº¤å¹¶æ¯”ï¼ˆIoUï¼‰æ¥ç”Ÿæˆæˆæœ¬çŸ©é˜µã€‚å®ƒæ¥å—ä¸¤ä¸ªç›®æ ‡åˆ—è¡¨ï¼Œåˆ¤æ–­è¾“å…¥æ˜¯å¦ä¸ºè¾¹ç•Œæ¡†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥ä½¿ç”¨è¿™äº›è¾¹ç•Œæ¡†è¿›è¡Œè®¡ç®—ï¼›å¦åˆ™ï¼Œä»ç›®æ ‡ä¸­æå–è¾¹ç•Œæ¡†ã€‚è®¡ç®—å®Œæˆåï¼Œè¿”å›çš„æˆæœ¬çŸ©é˜µæ˜¯é€šè¿‡1å‡å»IoUå€¼å¾—åˆ°çš„ï¼Œè¡¨ç¤ºè¶Šé«˜çš„IoUå¯¹åº”è¶Šä½çš„æˆæœ¬ã€‚

`embedding_distance`å‡½æ•°åˆ™æ˜¯åŸºäºç‰¹å¾åµŒå…¥æ¥è®¡ç®—ç›®æ ‡ä¸æ£€æµ‹ä¹‹é—´çš„è·ç¦»ã€‚å®ƒé¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªæˆæœ¬çŸ©é˜µï¼Œç„¶åæå–æ£€æµ‹çš„ç‰¹å¾ï¼Œå¹¶è®¡ç®—ç›®æ ‡çš„å¹³æ»‘ç‰¹å¾ä¸æ£€æµ‹ç‰¹å¾ä¹‹é—´çš„è·ç¦»ã€‚æœ€ç»ˆè¿”å›çš„æˆæœ¬çŸ©é˜µæ˜¯é€šè¿‡è·ç¦»è®¡ç®—å¾—åˆ°çš„ï¼Œä½¿ç”¨äº†æŒ‡å®šçš„è·ç¦»åº¦é‡ï¼ˆé»˜è®¤ä¸ºä½™å¼¦è·ç¦»ï¼‰ã€‚

æœ€åï¼Œ`fuse_score`å‡½æ•°å°†æˆæœ¬çŸ©é˜µä¸æ£€æµ‹åˆ†æ•°èåˆï¼Œç”Ÿæˆä¸€ä¸ªç»¼åˆçš„ç›¸ä¼¼åº¦çŸ©é˜µã€‚å®ƒé¦–å…ˆå°†æˆæœ¬çŸ©é˜µè½¬æ¢ä¸ºç›¸ä¼¼åº¦çŸ©é˜µï¼Œç„¶åå°†æ£€æµ‹åˆ†æ•°æ‰©å±•åˆ°ä¸æˆæœ¬çŸ©é˜µç›¸åŒçš„å½¢çŠ¶ï¼Œæœ€ç»ˆè®¡ç®—èåˆåçš„ç›¸ä¼¼åº¦çŸ©é˜µå¹¶è¿”å›ã€‚

æ€»ä½“è€Œè¨€ï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ç›®æ ‡è·Ÿè¸ªä¸­ç›®æ ‡åŒ¹é…çš„å¤šä¸ªå…³é”®åŠŸèƒ½ï¼Œé€šè¿‡è®¡ç®—ä¸åŒçš„æˆæœ¬çŸ©é˜µå’Œç›¸ä¼¼åº¦çŸ©é˜µæ¥æé«˜ç›®æ ‡è·Ÿè¸ªçš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚

#### 11.4 ultralytics\nn\backbone\EfficientFormerV2.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import torch
import torch.nn as nn
import math
import itertools

class Attention4D(nn.Module):
    def __init__(self, dim=384, key_dim=32, num_heads=8, attn_ratio=4, resolution=7, act_layer=nn.ReLU, stride=None):
        super().__init__()
        self.num_heads = num_heads  # æ³¨æ„åŠ›å¤´çš„æ•°é‡
        self.scale = key_dim ** -0.5  # ç¼©æ”¾å› å­
        self.key_dim = key_dim  # é”®çš„ç»´åº¦
        self.nh_kd = key_dim * num_heads  # æ€»çš„é”®ç»´åº¦

        # å¦‚æœæœ‰æ­¥å¹…ï¼Œåˆ™è°ƒæ•´åˆ†è¾¨ç‡å’Œå®šä¹‰å·ç§¯å±‚
        if stride is not None:
            self.resolution = math.ceil(resolution / stride)
            self.stride_conv = nn.Sequential(
                nn.Conv2d(dim, dim, kernel_size=3, stride=stride, padding=1, groups=dim),
                nn.BatchNorm2d(dim),
            )
            self.upsample = nn.Upsample(scale_factor=stride, mode='bilinear')
        else:
            self.resolution = resolution
            self.stride_conv = None
            self.upsample = None

        self.N = self.resolution ** 2  # æ¯ä¸ªåˆ†è¾¨ç‡çš„æ€»ç‚¹æ•°
        self.d = int(attn_ratio * key_dim)  # æ³¨æ„åŠ›è¾“å‡ºçš„ç»´åº¦
        self.dh = self.d * num_heads  # æ€»çš„è¾“å‡ºç»´åº¦
        self.attn_ratio = attn_ratio  # æ³¨æ„åŠ›æ¯”ç‡

        # å®šä¹‰æŸ¥è¯¢ã€é”®ã€å€¼çš„å·ç§¯å±‚
        self.q = nn.Sequential(nn.Conv2d(dim, self.num_heads * self.key_dim, 1), nn.BatchNorm2d(self.num_heads * self.key_dim))
        self.k = nn.Sequential(nn.Conv2d(dim, self.num_heads * self.key_dim, 1), nn.BatchNorm2d(self.num_heads * self.key_dim))
        self.v = nn.Sequential(nn.Conv2d(dim, self.num_heads * self.d, 1), nn.BatchNorm2d(self.num_heads * self.d))

        # å®šä¹‰å±€éƒ¨å€¼çš„å·ç§¯å±‚
        self.v_local = nn.Sequential(
            nn.Conv2d(self.num_heads * self.d, self.num_heads * self.d, kernel_size=3, stride=1, padding=1, groups=self.num_heads * self.d),
            nn.BatchNorm2d(self.num_heads * self.d),
        )

        # å®šä¹‰æŠ•å½±å±‚
        self.proj = nn.Sequential(act_layer(), nn.Conv2d(self.dh, dim, 1), nn.BatchNorm2d(dim))

        # è®¡ç®—æ³¨æ„åŠ›åç½®
        points = list(itertools.product(range(self.resolution), range(self.resolution)))
        N = len(points)
        attention_offsets = {}
        idxs = []
        for p1 in points:
            for p2 in points:
                offset = (abs(p1[0] - p2[0]), abs(p1[1] - p2[1]))
                if offset not in attention_offsets:
                    attention_offsets[offset] = len(attention_offsets)
                idxs.append(attention_offsets[offset])
        self.attention_biases = nn.Parameter(torch.zeros(num_heads, len(attention_offsets)))  # æ³¨æ„åŠ›åç½®å‚æ•°
        self.register_buffer('attention_bias_idxs', torch.LongTensor(idxs).view(N, N))  # æ³¨å†Œç¼“å†²åŒº

    @torch.no_grad()
    def train(self, mode=True):
        super().train(mode)
        if mode and hasattr(self, 'ab'):
            del self.ab  # åˆ é™¤ä¸´æ—¶å˜é‡
        else:
            self.ab = self.attention_biases[:, self.attention_bias_idxs]  # è®­ç»ƒæ¨¡å¼ä¸‹çš„æ³¨æ„åŠ›åç½®

    def forward(self, x):  # å‰å‘ä¼ æ’­
        B, C, H, W = x.shape  # è·å–è¾“å…¥çš„å½¢çŠ¶
        if self.stride_conv is not None:
            x = self.stride_conv(x)  # åº”ç”¨æ­¥å¹…å·ç§¯

        # è®¡ç®—æŸ¥è¯¢ã€é”®ã€å€¼
        q = self.q(x).flatten(2).reshape(B, self.num_heads, -1, self.N).permute(0, 1, 3, 2)
        k = self.k(x).flatten(2).reshape(B, self.num_heads, -1, self.N).permute(0, 1, 2, 3)
        v = self.v(x)
        v_local = self.v_local(v)
        v = v.flatten(2).reshape(B, self.num_heads, -1, self.N).permute(0, 1, 3, 2)

        # è®¡ç®—æ³¨æ„åŠ›æƒé‡
        attn = (q @ k) * self.scale + (self.attention_biases[:, self.attention_bias_idxs] if self.training else self.ab)
        attn = attn.softmax(dim=-1)  # åº”ç”¨softmax

        # è®¡ç®—è¾“å‡º
        x = (attn @ v)
        out = x.transpose(2, 3).reshape(B, self.dh, self.resolution, self.resolution) + v_local
        if self.upsample is not None:
            out = self.upsample(out)  # ä¸Šé‡‡æ ·

        out = self.proj(out)  # æŠ•å½±åˆ°è¾“å‡ºç»´åº¦
        return out


class EfficientFormerV2(nn.Module):
    def __init__(self, layers, embed_dims=None, mlp_ratios=4, downsamples=None, num_classes=1000):
        super().__init__()
        self.patch_embed = nn.Conv2d(3, embed_dims[0], kernel_size=3, stride=2, padding=1)  # åˆå§‹çš„å·ç§¯åµŒå…¥å±‚

        network = []
        for i in range(len(layers)):
            # æ„å»ºæ¯ä¸€å±‚çš„ç½‘ç»œå—
            stage = eformer_block(embed_dims[i], i, layers)
            network.append(stage)
            if downsamples[i] or embed_dims[i] != embed_dims[i + 1]:
                network.append(Embedding(patch_size=3, stride=2, in_chans=embed_dims[i], embed_dim=embed_dims[i + 1]))

        self.network = nn.ModuleList(network)  # å°†ç½‘ç»œå—ç»„åˆæˆModuleList

    def forward(self, x):
        x = self.patch_embed(x)  # é€šè¿‡åµŒå…¥å±‚
        for block in self.network:
            x = block(x)  # é€šè¿‡æ¯ä¸ªç½‘ç»œå—
        return x


def eformer_block(dim, index, layers):
    blocks = []
    for block_idx in range(layers[index]):
        blocks.append(AttnFFN(dim))  # æ·»åŠ æ³¨æ„åŠ›å‰é¦ˆç½‘ç»œ
    return nn.Sequential(*blocks)  # è¿”å›ä¸€ä¸ªé¡ºåºå®¹å™¨


def efficientformerv2_s0(weights='', **kwargs):
    model = EfficientFormerV2(layers=[2, 2, 6, 4], embed_dims=[32, 48, 96, 176])  # åˆ›å»ºæ¨¡å‹
    if weights:
        pretrained_weight = torch.load(weights)['model']
        model.load_state_dict(pretrained_weight)  # åŠ è½½é¢„è®­ç»ƒæƒé‡
    return model

# å…¶ä»–æ¨¡å‹æ„å»ºå‡½æ•°çœç•¥...

if __name__ == '__main__':
    inputs = torch.randn((1, 3, 640, 640))  # åˆ›å»ºè¾“å…¥å¼ é‡
    model = efficientformerv2_s0()  # å®ä¾‹åŒ–æ¨¡å‹
    res = model(inputs)  # å‰å‘ä¼ æ’­
    print(res.size())  # è¾“å‡ºç»“æœçš„å½¢çŠ¶
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è¯´æ˜ï¼š
1. **Attention4Dç±»**ï¼šå®ç°äº†ä¸€ä¸ªå››ç»´æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ”¯æŒä¸åŒçš„åˆ†è¾¨ç‡å’Œæ­¥å¹…ï¼Œèƒ½å¤Ÿè®¡ç®—æŸ¥è¯¢ã€é”®ã€å€¼ï¼Œå¹¶åº”ç”¨æ³¨æ„åŠ›æœºåˆ¶ã€‚
2. **EfficientFormerV2ç±»**ï¼šæ„å»ºäº†ä¸€ä¸ªé«˜æ•ˆçš„å˜æ¢å™¨æ¨¡å‹ï¼ŒåŒ…å«å¤šä¸ªå±‚çº§çš„ç½‘ç»œå—ï¼Œæ”¯æŒåµŒå…¥å’Œä¸‹é‡‡æ ·ã€‚
3. **eformer_blockå‡½æ•°**ï¼šç”¨äºåˆ›å»ºç‰¹å®šå±‚æ•°çš„ç½‘ç»œå—ï¼Œä¸»è¦ç”±æ³¨æ„åŠ›å‰é¦ˆç½‘ç»œç»„æˆã€‚
4. **efficientformerv2_s0å‡½æ•°**ï¼šæ„å»ºç‰¹å®šé…ç½®çš„EfficientFormerV2æ¨¡å‹ï¼Œå¹¶åŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚

è¿™äº›éƒ¨åˆ†æ˜¯å®ç°EfficientFormerçš„æ ¸å¿ƒï¼Œå…¶ä»–éƒ¨åˆ†ä¸»è¦ç”¨äºé…ç½®å’Œåˆå§‹åŒ–æ¨¡å‹ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶å®ç°äº†ä¸€ä¸ªåä¸ºEfficientFormerV2çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œä¸»è¦ç”¨äºè®¡ç®—æœºè§†è§‰ä»»åŠ¡ã€‚è¯¥æ¨¡å‹æ˜¯EfficientFormerç³»åˆ—çš„ä¸€éƒ¨åˆ†ï¼Œæ—¨åœ¨æé«˜è®¡ç®—æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚æ–‡ä»¶ä¸­åŒ…å«å¤šä¸ªç±»å’Œå‡½æ•°ï¼Œä¸‹é¢æ˜¯å¯¹å…¶ä¸»è¦å†…å®¹çš„è¯´æ˜ã€‚

é¦–å…ˆï¼Œæ–‡ä»¶å®šä¹‰äº†ä¸€äº›è¶…å‚æ•°å’Œæ¨¡å‹é…ç½®ï¼ŒåŒ…æ‹¬ä¸åŒç‰ˆæœ¬çš„EfficientFormerçš„å®½åº¦å’Œæ·±åº¦ã€‚é€šè¿‡å­—å…¸`EfficientFormer_width`å’Œ`EfficientFormer_depth`ï¼Œå¯ä»¥æ ¹æ®æ¨¡å‹çš„å¤§å°ï¼ˆå¦‚S0ã€S1ã€S2ã€Lï¼‰è·å–ç›¸åº”çš„é€šé“æ•°å’Œå±‚æ•°ã€‚

æ¥ä¸‹æ¥ï¼Œæ–‡ä»¶å®šä¹‰äº†å¤šä¸ªç±»ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯`EfficientFormerV2`ç±»ã€‚è¯¥ç±»ç»§æ‰¿è‡ª`nn.Module`ï¼Œæ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†æ¨¡å‹çš„å„ä¸ªéƒ¨åˆ†ï¼ŒåŒ…æ‹¬åµŒå…¥å±‚ã€å¤šä¸ªå—ï¼ˆç”±`eformer_block`å‡½æ•°ç”Ÿæˆï¼‰ä»¥åŠå¯èƒ½çš„ä¸‹é‡‡æ ·å±‚ã€‚`forward`æ–¹æ³•å®šä¹‰äº†æ¨¡å‹çš„å‰å‘ä¼ æ’­è¿‡ç¨‹ã€‚

åœ¨æ¨¡å‹çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œ`Attention4D`å’Œ`Attention4DDownsample`ç±»å®ç°äº†å››ç»´æ³¨æ„åŠ›æœºåˆ¶ï¼Œåˆ†åˆ«ç”¨äºå¤„ç†è¾“å…¥ç‰¹å¾å’Œä¸‹é‡‡æ ·æ“ä½œã€‚æ³¨æ„åŠ›æœºåˆ¶æ˜¯ç°ä»£æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­å¸¸ç”¨çš„æŠ€æœ¯ï¼Œèƒ½å¤Ÿå¸®åŠ©æ¨¡å‹æ›´å¥½åœ°æ•æ‰è¾“å…¥æ•°æ®ä¸­çš„é‡è¦ç‰¹å¾ã€‚

`Mlp`ç±»å®ç°äº†å¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰ï¼Œç”¨äºç‰¹å¾çš„è¿›ä¸€æ­¥å¤„ç†ã€‚`AttnFFN`å’Œ`FFN`ç±»åˆ™ç»“åˆäº†æ³¨æ„åŠ›æœºåˆ¶å’ŒMLPï¼Œå½¢æˆäº†å®Œæ•´çš„å‰é¦ˆç½‘ç»œç»“æ„ã€‚

æ­¤å¤–ï¼Œæ–‡ä»¶ä¸­è¿˜å®šä¹‰äº†ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œä¾‹å¦‚`update_weight`ç”¨äºæ›´æ–°æ¨¡å‹æƒé‡ï¼Œ`efficientformerv2_s0`ç­‰å‡½æ•°ç”¨äºåˆ›å»ºä¸åŒç‰ˆæœ¬çš„EfficientFormerV2æ¨¡å‹å¹¶åŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚

åœ¨æ–‡ä»¶çš„æœ€åéƒ¨åˆ†ï¼Œä½¿ç”¨`if __name__ == '__main__':`è¯­å¥å—æ¥æµ‹è¯•æ¨¡å‹çš„åŠŸèƒ½ã€‚é€šè¿‡éšæœºç”Ÿæˆçš„è¾“å…¥æ•°æ®ï¼Œåˆ›å»ºä¸åŒç‰ˆæœ¬çš„EfficientFormerV2æ¨¡å‹ï¼Œå¹¶æ‰“å°å‡ºæ¯ä¸ªæ¨¡å‹è¾“å‡ºçš„ç‰¹å¾å›¾çš„å°ºå¯¸ã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ–‡ä»¶å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„è§†è§‰æ¨¡å‹ï¼Œåˆ©ç”¨äº†æ³¨æ„åŠ›æœºåˆ¶å’Œå¤šå±‚æ„ŸçŸ¥æœºï¼Œé€‚ç”¨äºå„ç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡ã€‚é€šè¿‡ä¸åŒçš„æ¨¡å‹é…ç½®ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¨¡å‹ç‰ˆæœ¬ã€‚

#### 11.5 ultralytics\nn\autobackend.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
class AutoBackend(nn.Module):
    """
    å¤„ç†Ultralytics YOLOæ¨¡å‹çš„åŠ¨æ€åç«¯é€‰æ‹©ï¼Œç”¨äºæ¨ç†ã€‚
    """

    @torch.no_grad()
    def __init__(self, weights='yolov8n.pt', device=torch.device('cpu'), dnn=False, data=None, fp16=False, fuse=True, verbose=True):
        """
        åˆå§‹åŒ–AutoBackendä»¥è¿›è¡Œæ¨ç†ã€‚

        å‚æ•°:
            weights (str): æ¨¡å‹æƒé‡æ–‡ä»¶çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º'yolov8n.pt'ã€‚
            device (torch.device): è¿è¡Œæ¨¡å‹çš„è®¾å¤‡ï¼Œé»˜è®¤ä¸ºCPUã€‚
            dnn (bool): æ˜¯å¦ä½¿ç”¨OpenCV DNNæ¨¡å—è¿›è¡ŒONNXæ¨ç†ï¼Œé»˜è®¤ä¸ºFalseã€‚
            data (str | Path | optional): é¢å¤–çš„data.yamlæ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«ç±»åï¼Œé»˜è®¤ä¸ºNoneã€‚
            fp16 (bool): æ˜¯å¦å¯ç”¨åŠç²¾åº¦æ¨ç†ï¼Œä»…åœ¨ç‰¹å®šåç«¯æ”¯æŒï¼Œé»˜è®¤ä¸ºFalseã€‚
            fuse (bool): æ˜¯å¦èåˆConv2D + BatchNormå±‚ä»¥ä¼˜åŒ–ï¼Œé»˜è®¤ä¸ºTrueã€‚
            verbose (bool): æ˜¯å¦å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼Œé»˜è®¤ä¸ºTrueã€‚
        """
        super().__init__()
        # å¤„ç†æƒé‡è·¯å¾„å’Œç±»å‹
        w = str(weights[0] if isinstance(weights, list) else weights)
        pt, jit, onnx, xml, engine, coreml, saved_model, pb, tflite, edgetpu, tfjs, paddle, ncnn, triton = self._model_type(w)

        # ç¡®å®šFP16å’ŒNHWCæ ¼å¼
        fp16 &= pt or jit or onnx or xml or engine
        nhwc = coreml or saved_model or pb or tflite or edgetpu

        # è®¾ç½®é»˜è®¤æ­¥å¹…
        stride = 32  
        model, metadata = None, None

        # è®¾ç½®è®¾å¤‡
        cuda = torch.cuda.is_available() and device.type != 'cpu'  # æ£€æŸ¥CUDAå¯ç”¨æ€§
        if cuda and not any([nn_module, pt, jit, engine]):  # å¦‚æœCUDAå¯ç”¨ä¸”ä¸æ˜¯æ¨¡å‹æ ¼å¼
            device = torch.device('cpu')
            cuda = False

        # å¦‚æœæ¨¡å‹ä¸åœ¨æœ¬åœ°ï¼Œåˆ™å°è¯•ä¸‹è½½
        if not (pt or triton or nn_module):
            w = attempt_download_asset(w)

        # åŠ è½½æ¨¡å‹
        if nn_module:  # å†…å­˜ä¸­çš„PyTorchæ¨¡å‹
            model = weights.to(device)
            model = model.fuse(verbose=verbose) if fuse else model
            stride = max(int(model.stride.max()), 32)  # è·å–æ¨¡å‹æ­¥å¹…
            names = model.module.names if hasattr(model, 'module') else model.names  # è·å–ç±»å
            model.half() if fp16 else model.float()
            self.model = model  # æ˜¾å¼åˆ†é…æ¨¡å‹
            pt = True
        elif pt:  # PyTorchæ¨¡å‹
            from ultralytics.nn.tasks import attempt_load_weights
            model = attempt_load_weights(weights if isinstance(weights, list) else w, device=device, inplace=True, fuse=fuse)
            stride = max(int(model.stride.max()), 32)
            names = model.module.names if hasattr(model, 'module') else model.names
            model.half() if fp16 else model.float()
            self.model = model
        # å…¶ä»–æ¨¡å‹æ ¼å¼çš„åŠ è½½é€»è¾‘...
        
        # æ£€æŸ¥ç±»å
        if 'names' not in locals():  # å¦‚æœç±»åç¼ºå¤±
            names = self._apply_default_class_names(data)
        names = check_class_names(names)  # éªŒè¯ç±»å

        # ç¦ç”¨æ¢¯åº¦
        if pt:
            for p in model.parameters():
                p.requires_grad = False

        self.__dict__.update(locals())  # å°†æ‰€æœ‰å±€éƒ¨å˜é‡åˆ†é…ç»™self

    def forward(self, im, augment=False, visualize=False):
        """
        åœ¨YOLOv8 MultiBackendæ¨¡å‹ä¸Šè¿è¡Œæ¨ç†ã€‚

        å‚æ•°:
            im (torch.Tensor): è¦è¿›è¡Œæ¨ç†çš„å›¾åƒå¼ é‡ã€‚
            augment (bool): æ˜¯å¦åœ¨æ¨ç†æœŸé—´æ‰§è¡Œæ•°æ®å¢å¼ºï¼Œé»˜è®¤ä¸ºFalseã€‚
            visualize (bool): æ˜¯å¦å¯è§†åŒ–è¾“å‡ºé¢„æµ‹ï¼Œé»˜è®¤ä¸ºFalseã€‚

        è¿”å›:
            (tuple): åŒ…å«åŸå§‹è¾“å‡ºå¼ é‡å’Œå¤„ç†åçš„è¾“å‡ºï¼ˆå¦‚æœvisualize=Trueï¼‰ã€‚
        """
        b, ch, h, w = im.shape  # è·å–è¾“å…¥å›¾åƒçš„å½¢çŠ¶
        if self.fp16 and im.dtype != torch.float16:
            im = im.half()  # è½¬æ¢ä¸ºFP16
        if self.nhwc:
            im = im.permute(0, 2, 3, 1)  # è½¬æ¢å½¢çŠ¶

        # æ ¹æ®æ¨¡å‹ç±»å‹æ‰§è¡Œæ¨ç†
        if self.pt or self.nn_module:  # PyTorch
            y = self.model(im, augment=augment, visualize=visualize) if augment or visualize else self.model(im)
        # å…¶ä»–æ¨¡å‹æ ¼å¼çš„æ¨ç†é€»è¾‘...
        
        # è¿”å›å¤„ç†åçš„è¾“å‡º
        return self.from_numpy(y)

    def from_numpy(self, x):
        """
        å°†numpyæ•°ç»„è½¬æ¢ä¸ºå¼ é‡ã€‚

        å‚æ•°:
            x (np.ndarray): è¦è½¬æ¢çš„æ•°ç»„ã€‚

        è¿”å›:
            (torch.Tensor): è½¬æ¢åçš„å¼ é‡ã€‚
        """
        return torch.tensor(x).to(self.device) if isinstance(x, np.ndarray) else x

    @staticmethod
    def _model_type(p='path/to/model.pt'):
        """
        æ ¹æ®æ¨¡å‹æ–‡ä»¶è·¯å¾„è¿”å›æ¨¡å‹ç±»å‹ã€‚

        å‚æ•°:
            p: æ¨¡å‹æ–‡ä»¶çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º'path/to/model.pt'ã€‚
        """
        from ultralytics.engine.exporter import export_formats
        sf = list(export_formats().Suffix)  # è·å–æ”¯æŒçš„åç¼€
        name = Path(p).name
        types = [s in name for s in sf]  # æ£€æŸ¥æ–‡ä»¶ååç¼€
        return types  # è¿”å›æ¨¡å‹ç±»å‹
```

### ä¸»è¦åŠŸèƒ½æ¦‚è¿°ï¼š
1. **AutoBackendç±»**ï¼šè´Ÿè´£åŠ¨æ€é€‰æ‹©åç«¯ä»¥è¿è¡ŒYOLOæ¨¡å‹çš„æ¨ç†ã€‚
2. **åˆå§‹åŒ–æ–¹æ³•**ï¼šåŠ è½½æ¨¡å‹å¹¶è®¾ç½®è®¾å¤‡ã€æƒé‡ã€ç±»åç­‰å‚æ•°ã€‚
3. **forwardæ–¹æ³•**ï¼šæ‰§è¡Œæ¨ç†ï¼Œå¤„ç†è¾“å…¥å›¾åƒå¹¶è¿”å›è¾“å‡ºã€‚
4. **from_numpyæ–¹æ³•**ï¼šå°†numpyæ•°ç»„è½¬æ¢ä¸ºPyTorchå¼ é‡ã€‚
5. **_model_typeé™æ€æ–¹æ³•**ï¼šæ ¹æ®æ¨¡å‹æ–‡ä»¶è·¯å¾„è¿”å›æ¨¡å‹ç±»å‹ã€‚

### é‡è¦æ€§ï¼š
è¿™æ®µä»£ç çš„æ ¸å¿ƒåœ¨äºå®ƒä¸ºYOLOæ¨¡å‹æä¾›äº†ä¸€ä¸ªçµæ´»çš„åç«¯æ”¯æŒï¼Œä½¿å¾—æ¨¡å‹å¯ä»¥åœ¨ä¸åŒçš„ç¡¬ä»¶å’Œæ¡†æ¶ä¸Šè¿è¡Œï¼Œæå¤§åœ°å¢å¼ºäº†æ¨¡å‹çš„å¯ç”¨æ€§å’Œé€‚åº”æ€§ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶æ˜¯Ultralytics YOLOæ¨¡å‹çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸»è¦è´Ÿè´£åŠ¨æ€é€‰æ‹©åç«¯ä»¥è¿è¡Œæ¨ç†ã€‚å®ƒæ”¯æŒå¤šç§æ¨¡å‹æ ¼å¼ï¼ŒåŒ…æ‹¬PyTorchã€ONNXã€TensorRTç­‰ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾—åœ¨ä¸åŒå¹³å°ä¸Šéƒ¨ç½²æ¨¡å‹å˜å¾—æ›´åŠ ç®€å•ã€‚

æ–‡ä»¶é¦–å…ˆå¯¼å…¥äº†ä¸€äº›å¿…è¦çš„åº“ï¼ŒåŒ…æ‹¬æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚`torch`ã€`cv2`ã€`numpy`ç­‰ã€‚æ¥ç€å®šä¹‰äº†ä¸€ä¸ª`check_class_names`å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥å’Œè½¬æ¢ç±»åï¼Œç¡®ä¿å®ƒä»¬ç¬¦åˆé¢„æœŸçš„æ ¼å¼ã€‚

`AutoBackend`ç±»æ˜¯è¯¥æ–‡ä»¶çš„æ ¸å¿ƒï¼Œç»§æ‰¿è‡ª`torch.nn.Module`ã€‚åœ¨å…¶æ„é€ å‡½æ•°ä¸­ï¼Œæ¥å—å¤šä¸ªå‚æ•°ï¼Œå¦‚æ¨¡å‹æƒé‡è·¯å¾„ã€è®¾å¤‡ç±»å‹ã€æ˜¯å¦ä½¿ç”¨DNNæ¨¡å—ç­‰ã€‚æ„é€ å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨`_model_type`æ–¹æ³•æ¥ç¡®å®šæ¨¡å‹çš„ç±»å‹ï¼Œå¹¶æ ¹æ®ä¸åŒçš„æ¨¡å‹æ ¼å¼åŠ è½½ç›¸åº”çš„æ¨¡å‹ã€‚

åœ¨åŠ è½½æ¨¡å‹æ—¶ï¼Œä»£ç ä¼šæ ¹æ®ä¸åŒçš„åç«¯æ ¼å¼æ‰§è¡Œä¸åŒçš„åŠ è½½é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œå¯¹äºPyTorchæ¨¡å‹ï¼Œä½¿ç”¨`attempt_load_weights`å‡½æ•°åŠ è½½æƒé‡ï¼›å¯¹äºONNXæ¨¡å‹ï¼Œä½¿ç”¨OpenCVçš„DNNæ¨¡å—è¿›è¡ŒåŠ è½½ï¼›å¯¹äºTensorRTæ¨¡å‹ï¼Œåˆ™ä½¿ç”¨TensorRTçš„APIè¿›è¡ŒåŠ è½½ã€‚

åœ¨`forward`æ–¹æ³•ä¸­ï¼Œæ¨¡å‹æ¥æ”¶è¾“å…¥å›¾åƒå¹¶æ‰§è¡Œæ¨ç†ã€‚æ ¹æ®æ¨¡å‹çš„ç±»å‹ï¼Œä»£ç ä¼šè¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œæ¯”å¦‚å°†è¾“å…¥ä»PyTorchå¼ é‡è½¬æ¢ä¸ºNumPyæ•°ç»„ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨æ¨¡å‹çš„æ¨ç†æ–¹æ³•ã€‚æ¨ç†ç»“æœä¼šæ ¹æ®éœ€è¦è¿›è¡Œåå¤„ç†ï¼Œä»¥ä¾¿äºåç»­çš„ä½¿ç”¨ã€‚

æ­¤å¤–ï¼Œ`warmup`æ–¹æ³•ç”¨äºé€šè¿‡è¿è¡Œä¸€æ¬¡å‰å‘ä¼ é€’æ¥é¢„çƒ­æ¨¡å‹ï¼Œä»¥æé«˜åç»­æ¨ç†çš„é€Ÿåº¦ã€‚`_apply_default_class_names`å’Œ`_model_type`æ˜¯é™æ€æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºåº”ç”¨é»˜è®¤ç±»åå’Œç¡®å®šæ¨¡å‹ç±»å‹ã€‚

æ€»ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ä¸€ä¸ªçµæ´»çš„åç«¯é€‰æ‹©æœºåˆ¶ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸åŒçš„æ¨ç†å¼•æ“ä¹‹é—´åˆ‡æ¢ï¼Œä»è€Œæå‡YOLOæ¨¡å‹çš„ä½¿ç”¨ä½“éªŒã€‚

### 12.ç³»ç»Ÿæ•´ä½“ç»“æ„ï¼ˆèŠ‚é€‰ï¼‰

### ç¨‹åºæ•´ä½“åŠŸèƒ½å’Œæ„æ¶æ¦‚æ‹¬

Ultralytics YOLOé¡¹ç›®æ˜¯ä¸€ä¸ªç”¨äºç›®æ ‡æ£€æµ‹å’Œå›¾åƒåˆ†å‰²çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›é«˜æ•ˆã€çµæ´»ä¸”æ˜“äºä½¿ç”¨çš„æ¨¡å‹å’Œå·¥å…·ï¼Œä»¥ä¾¿äºåœ¨å„ç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡ä¸­è¿›è¡Œåº”ç”¨ã€‚è¯¥é¡¹ç›®åŒ…å«å¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„å·¥ä½œæµã€‚

- **æ¨¡å‹å®šä¹‰ä¸æ„å»º**ï¼šåœ¨`ultralytics/models`ç›®å½•ä¸‹ï¼Œæ¨¡å‹çš„å®šä¹‰å’Œæ„å»ºè¢«ç»„ç»‡åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œå…è®¸ç”¨æˆ·æ ¹æ®éœ€æ±‚é€‰æ‹©å’Œæ„å»ºä¸åŒçš„æ¨¡å‹ã€‚
- **ç›®æ ‡è·Ÿè¸ª**ï¼š`ultralytics/trackers/utils/matching.py`æ–‡ä»¶æä¾›äº†ç›®æ ‡åŒ¹é…çš„å·¥å…·ï¼Œè®¡ç®—ä¸åŒç›®æ ‡ä¹‹é—´çš„æˆæœ¬çŸ©é˜µï¼Œä»¥æé«˜è·Ÿè¸ªçš„å‡†ç¡®æ€§ã€‚
- **é«˜æ•ˆæ¨¡å‹**ï¼š`ultralytics/nn/backbone/EfficientFormerV2.py`å®ç°äº†EfficientFormerV2æ¨¡å‹ï¼Œä¸“æ³¨äºæé«˜è®¡ç®—æ•ˆç‡å’Œæ€§èƒ½ï¼Œé€‚ç”¨äºå„ç§è§†è§‰ä»»åŠ¡ã€‚
- **åç«¯é€‰æ‹©**ï¼š`ultralytics/nn/autobackend.py`æ–‡ä»¶å®ç°äº†åŠ¨æ€é€‰æ‹©æ¨ç†åç«¯çš„åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§æ¨¡å‹æ ¼å¼ï¼Œä½¿å¾—æ¨¡å‹éƒ¨ç½²æ›´åŠ çµæ´»ã€‚

### æ–‡ä»¶åŠŸèƒ½æ•´ç†è¡¨

| æ–‡ä»¶è·¯å¾„                                         | åŠŸèƒ½æè¿°                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------|
| `ultralytics/models/__init__.py`                | å¯¼å…¥å’Œå®šä¹‰å¯ç”¨çš„æ¨¡å‹ç±»ï¼ˆå¦‚YOLOã€RTDETRã€SAMï¼‰ï¼Œç®€åŒ–æ¨¡å—çš„ä½¿ç”¨ã€‚        |
| `ultralytics/models/sam/build.py`               | æ„å»ºä¸åŒå°ºå¯¸çš„Segment Anything Modelï¼ˆSAMï¼‰ï¼Œæä¾›æ¨¡å‹åˆå§‹åŒ–å’ŒåŠ è½½åŠŸèƒ½ã€‚ |
| `ultralytics/trackers/utils/matching.py`        | å®ç°ç›®æ ‡è·Ÿè¸ªä¸­çš„åŒ¹é…åŠŸèƒ½ï¼Œè®¡ç®—æˆæœ¬çŸ©é˜µå’Œç›¸ä¼¼åº¦çŸ©é˜µï¼Œä»¥æé«˜è·Ÿè¸ªå‡†ç¡®æ€§ã€‚ |
| `ultralytics/nn/backbone/EfficientFormerV2.py`  | å®ç°EfficientFormerV2æ¨¡å‹ï¼Œæä¾›é«˜æ•ˆçš„è§†è§‰ç‰¹å¾æå–å’Œå¤„ç†èƒ½åŠ›ã€‚        |
| `ultralytics/nn/autobackend.py`                 | åŠ¨æ€é€‰æ‹©æ¨ç†åç«¯ï¼Œæ”¯æŒå¤šç§æ¨¡å‹æ ¼å¼ï¼ˆå¦‚PyTorchã€ONNXã€TensorRTï¼‰ï¼Œç®€åŒ–æ¨ç†è¿‡ç¨‹ã€‚ |

é€šè¿‡è¿™äº›æ¨¡å—çš„ååŒå·¥ä½œï¼ŒUltralytics YOLOé¡¹ç›®èƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªå¼ºå¤§ä¸”çµæ´»çš„è®¡ç®—æœºè§†è§‰è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå„ç§åº”ç”¨åœºæ™¯ã€‚

### 13.å›¾ç‰‡ã€è§†é¢‘ã€æ‘„åƒå¤´å›¾åƒåˆ†å‰²Demo(å»é™¤WebUI)ä»£ç 

åœ¨è¿™ä¸ªåšå®¢å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•åœ¨ä¸ä½¿ç”¨WebUIçš„æƒ…å†µä¸‹ï¼Œå®ç°å›¾åƒåˆ†å‰²æ¨¡å‹çš„ä½¿ç”¨ã€‚æœ¬é¡¹ç›®ä»£ç å·²ç»ä¼˜åŒ–æ•´åˆï¼Œæ–¹ä¾¿ç”¨æˆ·å°†åˆ†å‰²åŠŸèƒ½åµŒå…¥è‡ªå·±çš„é¡¹ç›®ä¸­ã€‚
æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬å›¾ç‰‡ã€è§†é¢‘ã€æ‘„åƒå¤´å›¾åƒçš„åˆ†å‰²ï¼ŒROIåŒºåŸŸçš„è½®å»“æå–ã€ç±»åˆ«åˆ†ç±»ã€å‘¨é•¿è®¡ç®—ã€é¢ç§¯è®¡ç®—ã€åœ†åº¦è®¡ç®—ä»¥åŠé¢œè‰²æå–ç­‰ã€‚
è¿™äº›åŠŸèƒ½æä¾›äº†è‰¯å¥½çš„äºŒæ¬¡å¼€å‘åŸºç¡€ã€‚

### æ ¸å¿ƒä»£ç è§£è¯»

ä»¥ä¸‹æ˜¯ä¸»è¦ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬ä¼šä¸ºæ¯ä¸€å—ä»£ç è¿›è¡Œè¯¦ç»†çš„æ‰¹æ³¨è§£é‡Šï¼š

```python
import random
import cv2
import numpy as np
from PIL import ImageFont, ImageDraw, Image
from hashlib import md5
from model import Web_Detector
from chinese_name_list import Label_list

# æ ¹æ®åç§°ç”Ÿæˆé¢œè‰²
def generate_color_based_on_name(name):
    ......

# è®¡ç®—å¤šè¾¹å½¢é¢ç§¯
def calculate_polygon_area(points):
    return cv2.contourArea(points.astype(np.float32))

...
# ç»˜åˆ¶ä¸­æ–‡æ ‡ç­¾
def draw_with_chinese(image, text, position, font_size=20, color=(255, 0, 0)):
    image_pil = Image.fromarray(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
    draw = ImageDraw.Draw(image_pil)
    font = ImageFont.truetype("simsun.ttc", font_size, encoding="unic")
    draw.text(position, text, font=font, fill=color)
    return cv2.cvtColor(np.array(image_pil), cv2.COLOR_RGB2BGR)

# åŠ¨æ€è°ƒæ•´å‚æ•°
def adjust_parameter(image_size, base_size=1000):
    max_size = max(image_size)
    return max_size / base_size

# ç»˜åˆ¶æ£€æµ‹ç»“æœ
def draw_detections(image, info, alpha=0.2):
    name, bbox, conf, cls_id, mask = info['class_name'], info['bbox'], info['score'], info['class_id'], info['mask']
    adjust_param = adjust_parameter(image.shape[:2])
    spacing = int(20 * adjust_param)

    if mask is None:
        x1, y1, x2, y2 = bbox
        aim_frame_area = (x2 - x1) * (y2 - y1)
        cv2.rectangle(image, (x1, y1), (x2, y2), color=(0, 0, 255), thickness=int(3 * adjust_param))
        image = draw_with_chinese(image, name, (x1, y1 - int(30 * adjust_param)), font_size=int(35 * adjust_param))
        y_offset = int(50 * adjust_param)  # ç±»åˆ«åç§°ä¸Šæ–¹ç»˜åˆ¶ï¼Œå…¶ä¸‹æ–¹ç•™å‡ºç©ºé—´
    else:
        mask_points = np.concatenate(mask)
        aim_frame_area = calculate_polygon_area(mask_points)
        mask_color = generate_color_based_on_name(name)
        try:
            overlay = image.copy()
            cv2.fillPoly(overlay, [mask_points.astype(np.int32)], mask_color)
            image = cv2.addWeighted(overlay, 0.3, image, 0.7, 0)
            cv2.drawContours(image, [mask_points.astype(np.int32)], -1, (0, 0, 255), thickness=int(8 * adjust_param))

            # è®¡ç®—é¢ç§¯ã€å‘¨é•¿ã€åœ†åº¦
            area = cv2.contourArea(mask_points.astype(np.int32))
            perimeter = cv2.arcLength(mask_points.astype(np.int32), True)
            ......

            # è®¡ç®—è‰²å½©
            mask = np.zeros(image.shape[:2], dtype=np.uint8)
            cv2.drawContours(mask, [mask_points.astype(np.int32)], -1, 255, -1)
            color_points = cv2.findNonZero(mask)
            ......

            # ç»˜åˆ¶ç±»åˆ«åç§°
            x, y = np.min(mask_points, axis=0).astype(int)
            image = draw_with_chinese(image, name, (x, y - int(30 * adjust_param)), font_size=int(35 * adjust_param))
            y_offset = int(50 * adjust_param)

            # ç»˜åˆ¶é¢ç§¯ã€å‘¨é•¿ã€åœ†åº¦å’Œè‰²å½©å€¼
            metrics = [("Area", area), ("Perimeter", perimeter), ("Circularity", circularity), ("Color", color_str)]
            for idx, (metric_name, metric_value) in enumerate(metrics):
                ......

    return image, aim_frame_area

# å¤„ç†æ¯å¸§å›¾åƒ
def process_frame(model, image):
    pre_img = model.preprocess(image)
    pred = model.predict(pre_img)
    det = pred[0] if det is not None and len(det)
    if det:
        det_info = model.postprocess(pred)
        for info in det_info:
            image, _ = draw_detections(image, info)
    return image

if __name__ == "__main__":
    cls_name = Label_list
    model = Web_Detector()
    model.load_model("./weights/yolov8s-seg.pt")

    # æ‘„åƒå¤´å®æ—¶å¤„ç†
    cap = cv2.VideoCapture(0)
    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            break
        ......

    # å›¾ç‰‡å¤„ç†
    image_path = './icon/OIP.jpg'
    image = cv2.imread(image_path)
    if image is not None:
        processed_image = process_frame(model, image)
        ......

    # è§†é¢‘å¤„ç†
    video_path = ''  # è¾“å…¥è§†é¢‘çš„è·¯å¾„
    cap = cv2.VideoCapture(video_path)
    while cap.isOpened():
        ret, frame = cap.read()
        ......
```


### 14.å®Œæ•´è®­ç»ƒ+Webå‰ç«¯ç•Œé¢+50+ç§åˆ›æ–°ç‚¹æºç ã€æ•°æ®é›†è·å–

![19.png](19.png)


# [ä¸‹è½½é“¾æ¥ï¼šhttps://mbd.pub/o/bread/Z5yWm5Zs](https://mbd.pub/o/bread/Z5yWm5Zs)